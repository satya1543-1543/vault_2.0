<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Favicon Link -->
    <link rel="icon" type="image/png" href="https://i.ibb.co/7JfMHZQj/vault.png">

    <!-- PWA Manifest Link (Ensure manifest.json exists at the root) -->
    <link rel="manifest" href="manifest.json">

    <!-- PWA Theme color -->
    <meta name="theme-color" content="#4a77d4"> <!-- Updated theme color -->

    <!-- Add to home screen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Local Vault">
    <!-- Optional: Add Apple touch icons if needed -->
    <!-- <link rel="apple-touch-icon" href="icons/apple-touch-icon.png"> -->

    <title>Vault</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"> <!-- Updated Font Awesome -->

    <style>
        /* --- Start Embedded CSS --- */

        /* --- Variables & Base --- */
        :root {
            --primary-color: #4a77d4; /* A richer, slightly darker blue */
            --primary-light: #eaf0ff; /* Light blue for backgrounds/highlights */
            --secondary-color: #34d399; /* Vibrant green */
            --tertiary-color: #f97316; /* Vibrant orange */
            --background-start: #f0f4ff; /* Very light blue */
            --background-end: #fdf6ff;   /* Very light purple */
            --card-background: #ffffff;
            --text-color: #1f2937; /* Dark grey-blue */
            --text-muted: #6b7280; /* Medium grey */
            --border-color: #e5e7eb; /* Light grey border */
            --danger-color: #ef4444; /* Brighter red */
            --success-color: #10b981; /* Brighter green */
            --font-family: 'Poppins', sans-serif;
            --border-radius: 12px; /* More rounded */
            --base-shadow: 0 5px 15px rgba(0, 0, 0, 0.07);
            --hover-shadow: 0 10px 25px rgba(74, 119, 212, 0.15);
            --focus-shadow: 0 0 0 4px rgba(74, 119, 212, 0.2);

            /* Button 57 Specific Colors (Adjusted for consistency) */
            --btn57-dark: var(--text-color);
            --btn57-light: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            color: var(--text-color);
            line-height: 1.6; /* Slightly reduced for better density */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: linear-gradient(145deg, var(--background-start), var(--background-end));
            background-size: 200% 200%; /* Smaller size for faster perceived movement */
            animation: gradientBG 20s ease infinite;
            overflow-x: hidden; /* Prevent horizontal scroll */
            transition: background-color 0.5s ease; /* Smooth transition if needed */
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Utility Classes --- */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            margin: -1px;
            padding: 0;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* --- Login Screen Styles --- */
        #login-screen {
            position: fixed;
            inset: 0; /* Replaces top/left/width/height */
            background: rgba(240, 244, 255, 0.8); /* Match background start color */
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            opacity: 0;
            visibility: hidden; /* Use visibility for better accessibility */
            transform: scale(1.05); /* Start slightly larger for animation */
            transition: opacity 0.4s cubic-bezier(0.25, 0.8, 0.25, 1),
                        visibility 0.4s linear,
                        transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        #login-screen.visible {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
        }

        .login-container {
            background-color: var(--card-background);
            padding: 2.5rem 3rem;
            border-radius: var(--border-radius);
            box-shadow: var(--hover-shadow);
            text-align: center;
            max-width: 420px;
            width: 100%;
            transform: translateY(20px); /* Start slightly lower for animation */
            transition: transform 0.5s cubic-bezier(0.25, 0.8, 0.25, 1) 0.1s; /* Delayed transition */
        }
        #login-screen.visible .login-container {
            transform: translateY(0);
        }

        .login-container h2 {
            color: var(--primary-color);
            margin-bottom: 0.8rem;
            font-size: 1.9rem;
            font-weight: 600;
        }
        .login-container h2 i {
            margin-right: 0.7rem;
            vertical-align: middle; /* Better icon alignment */
        }

        .login-container p {
            color: var(--text-muted);
            margin-bottom: 2rem;
            font-size: 1rem;
            line-height: 1.5;
        }

        #pin-entry-section, #pin-setup-section {
             margin-bottom: 1.5rem;
        }

        .pin-input-container {
            display: flex;
            justify-content: center;
            gap: 12px; /* Slightly reduced gap */
            margin-bottom: 1.5rem;
        }

        .pin-digit {
            width: 60px; /* Slightly wider */
            height: 70px;
            font-size: 2.2rem;
            font-weight: 600; /* Bolder digits */
            text-align: center;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: #f9fafb; /* Slightly off-white */
            color: var(--text-color);
            caret-color: var(--primary-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
            -moz-appearance: textfield;
            appearance: textfield;
            line-height: 66px; /* Vertically center text */
        }
        .pin-digit::-webkit-outer-spin-button,
        .pin-digit::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0;
        }

        .pin-digit:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: var(--focus-shadow);
            transform: scale(1.05); /* Subtle scale on focus */
        }
        .pin-digit.error { /* Style for error state */
            border-color: var(--danger-color);
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        #pin-error-message {
            color: var(--danger-color);
            min-height: 1.3em;
            margin-top: -1rem;
            margin-bottom: 1rem;
            font-weight: 500; /* Slightly less bold */
            font-size: 0.95rem;
            transition: opacity 0.3s ease;
        }

        @keyframes shake {
          10%, 90% { transform: translateX(-1px); }
          20%, 80% { transform: translateX(2px); }
          30%, 50%, 70% { transform: translateX(-4px); }
          40%, 60% { transform: translateX(4px); }
        }

        /* Setup Form Styles (Kept for visual consistency/info) */
        #pin-setup-section .form-group { margin-bottom: 1rem; text-align: left; }
        #pin-setup-section label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-muted); font-size: 0.9rem; }
        #pin-setup-section input[type="password"] { width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 1rem; }
        #pin-setup-section input[type="password"]:focus { outline: none; border-color: var(--primary-color); box-shadow: var(--focus-shadow); }
        #setup-pin-button { margin-top: 1rem; width: 100%; }
        #setup-error-message { color: var(--danger-color); min-height: 1.2em; margin-top: 0.5rem; font-weight: 500; font-size: 0.9rem; }

        /* --- Vault Container (Initially Hidden) --- */
        #vault-container {
            display: none; /* Hide vault initially */
            width: 100%;
            max-width: 900px; /* Slightly wider */
            margin: 3rem auto;
            padding: 2.5rem 3rem; /* More padding */
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--base-shadow);
            flex-grow: 1;
            opacity: 0; /* For fade-in animation */
            transform: translateY(20px); /* For slide-up animation */
            transition: opacity 0.6s ease-out, transform 0.6s ease-out, box-shadow 0.3s ease;
        }
        #vault-container.visible {
            opacity: 1;
            transform: translateY(0);
        }
        #vault-container:hover {
             box-shadow: var(--hover-shadow);
        }

        /* --- Header --- */
        header {
            text-align: center;
            margin-bottom: 3.5rem; /* More space */
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            position: relative; /* For potential decorative elements */
        }

        header h1 {
            color: var(--primary-color);
            margin-bottom: 0;
            font-weight: 700; /* Bolder */
            font-size: 2.4rem;
            word-break: break-word;
        }

        header h1 .icon {
            margin-right: 0.8rem;
            vertical-align: middle;
            font-size: 2.2rem; /* Slightly smaller icon relative to text */
            opacity: 0.8;
        }

        /* --- Sections & Headings --- */
        .add-password-form,
        .password-list-section {
            margin-bottom: 3rem; /* More space between sections */
            padding: 2.5rem; /* More padding */
            background-color: #fdfdff; /* Very subtle off-white */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04); /* Softer shadow */
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2.5rem; /* More space */
            flex-wrap: wrap;
            gap: 1rem;
            border-bottom: 1px solid var(--border-color); /* Add subtle separator */
            padding-bottom: 1.5rem; /* Space below separator */
        }

        h2 { /* Shared by login and vault */
            color: var(--primary-color);
            font-weight: 600;
            font-size: 1.7rem; /* Slightly larger */
            display: inline-flex; /* Use flex for icon alignment */
            align-items: center;
            gap: 0.8rem; /* Space between icon and text */
            margin: 0; /* Remove default margins */
            flex-shrink: 0;
        }
        h2 i { /* Style icons within h2 */
            font-size: 1.5rem; /* Adjust icon size */
            opacity: 0.9;
        }
        /* Remove border from login h2 */
        .login-container h2 { border-bottom: none; padding-bottom: 0; }
        /* Keep border for vault sections (now handled by .section-header) */
        #vault-container .section-header h2 { border-bottom: none; padding-bottom: 0; }


        /* --- Forms --- */
        .form-group {
            margin-bottom: 1.8rem; /* More space */
        }

        .form-group label {
            display: block;
            margin-bottom: 0.7rem; /* More space */
            font-weight: 500; /* Medium weight */
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .form-group input[type="text"],
        .form-group input[type="password"],
        .search-container input[type="text"] {
            width: 100%;
            padding: 0.95rem 1.2rem; /* Slightly more padding */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-family: inherit;
            color: var(--text-color);
            background-color: #fff;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
        }
        .form-group input::placeholder,
        .search-container input::placeholder {
            color: #a0aec0; /* Lighter placeholder */
        }

        .form-group input:focus,
        .search-container input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: var(--focus-shadow);
            background-color: #fcfdff; /* Subtle background change on focus */
        }

        .password-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-input-wrapper input {
            padding-right: 3.8rem; /* More space for button */
        }

        .toggle-visibility {
            position: absolute;
            right: 1px;
            top: 1px;
            bottom: 1px;
            width: 3.5rem; /* Slightly wider */
            background: transparent;
            border: none;
            border-left: 1px solid var(--border-color);
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1.2rem; /* Larger icon */
            transition: color 0.3s ease, background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-visibility:hover,
        .toggle-visibility:focus { /* Add focus style */
            color: var(--primary-color);
            background-color: var(--primary-light);
            outline: none;
        }

        .toggle-visibility i {
            pointer-events: none;
            transition: transform 0.2s ease-in-out; /* Add transition to icon */
        }
        .toggle-visibility:hover i,
        .toggle-visibility:focus i {
            transform: scale(1.1); /* Slightly scale icon on hover/focus */
        }

        /* --- Button 57 Styles (Refined) --- */
        .button-57 {
          position: relative;
          overflow: hidden;
          border: 2px solid var(--btn57-dark); /* Slightly thicker border */
          color: var(--btn57-dark);
          display: inline-block;
          font-size: 1rem; /* Base size */
          line-height: 1.2; /* Adjust line height */
          padding: 14px 22px; /* Adjusted padding */
          text-decoration: none;
          cursor: pointer;
          background: var(--btn57-light);
          user-select: none;
          -webkit-user-select: none;
          touch-action: manipulation;
          border-radius: var(--border-radius);
          font-family: inherit;
          font-weight: 600; /* Bolder */
          margin: 5px;
          vertical-align: middle;
          text-align: center;
          transition: all 0.3s ease, transform 0.15s ease; /* Faster transform */
          will-change: transform; /* Optimize animation */
        }
        .button-57:active:not(:disabled) {
            transform: translateY(2px) scale(0.98); /* Add press effect */
        }

        .button-57 .text { /* Use .text class */
          position: relative;
          transition: color 600ms cubic-bezier(0.48, 0, 0.12, 1);
          z-index: 10;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          width: 100%;
          gap: 0.6rem; /* Use gap for icon spacing */
        }
        .button-57 .text i {
            margin-right: 0; /* Remove margin, use gap */
            font-size: 1.1em; /* Slightly larger icon */
            line-height: 1; /* Prevent icon affecting line height */
        }

        .button-57 .sub-text { /* Use .sub-text class */
          color: var(--btn57-light);
          display: block;
          position: absolute;
          bottom: 0;
          transition: all 500ms cubic-bezier(0.48, 0, 0.12, 1);
          z-index: 100;
          opacity: 0;
          top: 50%;
          left: 50%;
          transform: translateY(225%) translateX(-50%);
          height: auto; /* Allow height to adjust */
          line-height: 1.2;
          white-space: nowrap;
          font-weight: 500; /* Slightly lighter sub-text */
        }

        .button-57:after {
          content: "";
          position: absolute;
          bottom: -50%;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: var(--btn57-dark);
          transform-origin: bottom center;
          transition: transform 600ms cubic-bezier(0.48, 0, 0.12, 1);
          transform: skewY(9.3deg) scaleY(0);
          z-index: 50;
          border-radius: inherit;
        }

        .button-57:hover:not(:disabled):after {
          transform-origin: bottom center;
          transform: skewY(9.3deg) scaleY(2);
        }

        .button-57:hover:not(:disabled) .sub-text {
          transform: translateX(-50%) translateY(-50%); /* Center vertically */
          opacity: 1;
          transition: all 900ms cubic-bezier(0.48, 0, 0.12, 1);
        }

        .button-57:disabled {
            opacity: 0.5; /* More faded */
            cursor: not-allowed;
            border-color: var(--border-color); /* Grey border when disabled */
            color: var(--text-muted); /* Grey text when disabled */
            background-color: #f9fafb; /* Slightly grey background */
        }
        .button-57:disabled:after {
             transform: skewY(9.3deg) scaleY(0);
        }
        .button-57:disabled .sub-text {
            opacity: 0;
        }

        /* --- Button 57 Color Variations --- */
        /* Primary (Add/Save/Set PIN) */
        .button-57-primary { border-color: var(--primary-color); color: var(--primary-color); }
        .button-57-primary:after { background-color: var(--primary-color); }
        .button-57-primary:hover:not(:disabled) .text { color: var(--btn57-light); }
        .button-57-primary:disabled { border-color: var(--primary-color); background: var(--primary-light); color: var(--primary-color);} /* Keep color hint when disabled */

        /* Secondary (Copy) */
        .button-57-secondary {
            border-color: var(--secondary-color); color: var(--secondary-color);
            padding: 10px 16px; /* Smaller padding */
            font-size: 0.9rem;
        }
        .button-57-secondary:after { background-color: var(--secondary-color); }
        .button-57-secondary:hover:not(:disabled) .text { color: var(--btn57-dark); }
        .button-57-secondary .sub-text { color: var(--btn57-dark); }

        /* Copied State for Secondary */
        .button-57-secondary.copied {
            border-color: var(--success-color);
            color: var(--btn57-light); /* Text light */
            background-color: var(--success-color); /* Fill background */
            pointer-events: none; /* Prevent interaction while copied */
        }
        .button-57-secondary.copied:after {
             transform: skewY(9.3deg) scaleY(0); /* Hide wipe effect */
        }
         .button-57-secondary.copied .text i {
             animation: pulse 0.5s ease-out; /* Add pulse animation to checkmark */
         }
         .button-57-secondary.copied .sub-text {
             opacity: 0;
         }
         @keyframes pulse {
             0% { transform: scale(1); }
             50% { transform: scale(1.2); }
             100% { transform: scale(1); }
         }

        /* Danger (Delete) */
        .button-57-danger {
            border-color: var(--danger-color); color: var(--danger-color);
            padding: 10px 16px; /* Smaller padding */
            font-size: 0.9rem;
        }
        .button-57-danger:after { background-color: var(--danger-color); }
        .button-57-danger:hover:not(:disabled) .text { color: var(--btn57-light); }

        /* Export */
        .button-57-export { border-color: var(--tertiary-color); color: var(--tertiary-color); }
        .button-57-export:after { background-color: var(--tertiary-color); }
        .button-57-export:hover:not(:disabled) .text { color: var(--btn57-light); }

        /* --- Password List --- */
        .search-container {
            position: relative;
            margin-bottom: 2.5rem; /* More space */
        }

        .search-container input {
            padding-left: 3.2rem; /* More space for icon */
            background-color: #f9fafb; /* Slightly different background */
        }
        .search-container input:focus {
             background-color: #fff; /* White on focus */
        }

        .search-icon {
            position: absolute;
            left: 1.2rem; /* Position icon */
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1.1rem;
            pointer-events: none;
            transition: color 0.3s ease;
        }
        .search-container input:focus + .search-icon {
            color: var(--primary-color); /* Change icon color on focus */
        }

        .password-list {
            list-style: none;
            padding: 0;
        }

        .password-list li {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem; /* More space */
            padding: 1.8rem 2.2rem; /* More padding */
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem; /* More gap */
            box-shadow: var(--base-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-left 0.3s ease;
            border-left: 5px solid transparent; /* For hover effect */
            opacity: 0; /* For entrance animation */
            transform: translateY(15px); /* For entrance animation */
            animation: fadeInSlideUp 0.5s ease-out forwards;
            animation-delay: calc(var(--animation-order) * 60ms); /* Stagger animation */
        }
        @keyframes fadeInSlideUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .password-list li:hover {
             transform: translateY(-5px); /* Lift effect */
             box-shadow: var(--hover-shadow);
             border-left-color: var(--primary-color); /* Highlight border on hover */
        }

        .password-list li.no-entries {
            text-align: center;
            color: var(--text-muted);
            padding: 3rem;
            font-style: italic;
            justify-content: center;
            border: 2px dashed var(--border-color);
            background-color: #fcfcfc;
            box-shadow: none;
            transform: none;
            flex-direction: column;
            opacity: 1; /* Ensure visible */
            animation: none; /* No animation */
            border-left: none; /* No border effect */
        }
        .password-list li.no-entries:hover {
             transform: none;
             box-shadow: none;
             border-left: none;
        }
        .password-list li.no-entries i { /* Style icon in no-entries */
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--primary-light);
        }


        .password-entry-details {
            flex-grow: 1;
            min-width: 220px;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
        }

        .password-entry-details strong {
            color: var(--primary-color);
            display: block;
            font-size: 1.3rem; /* Larger website name */
            font-weight: 600;
            margin-bottom: 0.8rem; /* More space */
            line-height: 1.3;
        }

        .password-entry-details .detail-item {
            margin-bottom: 0.6rem; /* More space */
            font-size: 1rem;
            color: var(--text-color);
            display: flex;
            align-items: center; /* Center align label and value */
            gap: 0.8rem;
        }

        .detail-item .label {
            font-weight: 500;
            color: var(--text-muted);
            min-width: 60px; /* Ensure alignment */
            font-size: 0.9rem;
            flex-shrink: 0;
            display: inline-flex; /* Align icon within label */
            align-items: center;
            gap: 0.4rem;
        }
        .detail-item .label i {
            font-size: 0.9em; /* Icon size relative to label */
            opacity: 0.7;
        }

        .detail-item .username-value,
        .detail-item .password-value-container {
            flex-grow: 1;
            min-width: 0;
            font-weight: 500; /* Make values slightly bolder */
        }

        .password-value-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .password-value {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; /* Monospace font */
            cursor: pointer;
            display: inline-block;
            background-color: #f3f4f6; /* Lighter grey */
            padding: 0.3rem 0.7rem;
            border-radius: 6px; /* Smaller radius */
            user-select: none;
            transition: background-color 0.3s ease, color 0.3s ease, letter-spacing 0.3s ease;
            line-height: 1.4;
            word-break: break-all;
            letter-spacing: 2px; /* More spacing for masked */
            font-size: 1.1rem; /* Slightly larger */
            color: var(--text-muted);
        }

        .password-value:hover {
            background-color: #e5e7eb; /* Darker grey on hover */
        }

        .password-value.visible {
            background-color: transparent;
            padding: 0.3rem 0;
            user-select: text;
            color: var(--success-color);
            font-weight: 500;
            letter-spacing: normal; /* Normal spacing when visible */
            font-size: 1rem; /* Normal size when visible */
        }

        .password-entry-actions {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex-shrink: 0;
            gap: 0.6rem; /* More space between buttons */
        }

        /* --- Footer --- */
        footer {
            text-align: center;
            margin-top: 4rem; /* More space */
            padding: 2rem;
            font-size: 0.9rem;
            color: var(--text-muted);
            background-color: rgba(255, 255, 255, 0.7);
            border-top: 1px solid var(--border-color);
        }
        footer p { /* Style footer text */
            font-family: 'Poppins', sans-serif; /* Ensure font */
            font-weight: 400;
            letter-spacing: 0.5px; /* Add subtle spacing */
        }

        /* --- Loading Spinner --- */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
            margin: 2rem auto; /* Center spinner */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-overlay { /* Optional overlay for loading */
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }


        /* --- Responsive Design --- */

        /* Medium Screens (Tablets) */
        @media (max-width: 768px) {
            html { font-size: 15px; }
            #vault-container {
                margin: 2rem 1rem;
                padding: 2rem 1.5rem;
            }
            .login-container {
                padding: 2rem 1.5rem;
                max-width: 380px;
            }
            .pin-digit {
                width: 55px; height: 65px; font-size: 2rem; line-height: 61px;
            }
            .pin-input-container { gap: 10px; }

            header h1 { font-size: 2rem; }
            .section-header { margin-bottom: 2rem; padding-bottom: 1rem; }
            h2 { font-size: 1.5rem; }
            h2 i { font-size: 1.3rem; }

            .section-header .button-57-export { width: 100%; margin: 0; }
            #password-form .button-57-primary { width: 100%; margin-left: 0; margin-right: 0; }

            .password-list li {
                flex-direction: column;
                align-items: stretch;
                padding: 1.5rem 1.8rem;
                gap: 1.2rem;
                border-left-width: 4px;
            }
            .password-list li:hover { transform: translateY(-3px); }

            .password-entry-details { min-width: auto; }
            .password-entry-actions { justify-content: flex-end; gap: 0.8rem; } /* More gap on mobile */
            .button-57-secondary, .button-57-danger { padding: 9px 14px; font-size: 0.85rem; }
        }

        /* Small Screens (Phones) */
        @media (max-width: 480px) {
            html { font-size: 14px; }
            body { line-height: 1.5; }
            #vault-container {
                margin: 1rem 0.5rem;
                padding: 1.5rem 1rem;
                border-radius: 10px;
            }
            .login-container {
                padding: 1.8rem 1rem;
                max-width: 95%;
            }
            .pin-digit {
                width: 50px; height: 60px; font-size: 1.8rem; line-height: 56px;
            }
            .pin-input-container { gap: 8px; }

            .add-password-form, .password-list-section { padding: 1.5rem 1.2rem; }

            header { margin-bottom: 2.5rem; padding-bottom: 1.2rem; }
            header h1 { font-size: 1.8rem; }
            header h1 .icon { font-size: 1.6rem; }

            .section-header { margin-bottom: 1.8rem; gap: 0.8rem; padding-bottom: 1rem;}
            h2 { font-size: 1.4rem; gap: 0.6rem; }
            h2 i { font-size: 1.2rem; }

            .button-57 { font-size: 0.95rem; padding: 12px 18px; margin: 4px; }
            .button-57-secondary, .button-57-danger { font-size: 0.8rem; padding: 8px 12px; }
            .button-57-export, #password-form .button-57-primary, #setup-pin-button {
                 font-size: 0.95rem; padding: 12px 18px;
            }

            .password-entry-details strong { font-size: 1.2rem; }
            .password-entry-details .detail-item { font-size: 0.95rem; gap: 0.6rem; }
            .detail-item .label { min-width: 50px; font-size: 0.85rem; gap: 0.3rem;}
            .password-value { font-size: 1rem; letter-spacing: 1.5px; }
            .password-value.visible { font-size: 0.95rem; }

            .password-list li { padding: 1.2rem 1.5rem; gap: 1rem; border-left-width: 3px; }

            .search-container input { padding-left: 2.8rem; }
            .search-icon { left: 1rem; font-size: 1rem; }

            footer { padding: 1.5rem; margin-top: 3rem; }
        }
        /* --- End Embedded CSS --- */
    </style>
</head>
<body>

    <!-- Loading Indicator (Initially Hidden) -->
    <div id="loading-indicator" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen"> <!-- Controlled by JS -->
        <div class="login-container">
            <!-- PIN Setup Section (Informational) -->
            <div id="pin-setup-section" style="display: none;">
                <h2><i class="fas fa-user-shield"></i> Set Up Your PIN</h2>
                <p>PIN setup must be done via the server-side <code>setup_pin.php</code> script. Contact the administrator if a PIN needs to be set or reset.</p>
                <form id="pin-setup-form">
                    <div class="form-group">
                        <label for="new-pin">Enter 4-Digit PIN</label>
                        <input type="password" id="new-pin" inputmode="numeric" pattern="[0-9]*" minlength="4" maxlength="4" required autocomplete="new-password" disabled>
                    </div>
                    <div class="form-group">
                        <label for="confirm-pin">Confirm PIN</label>
                        <input type="password" id="confirm-pin" inputmode="numeric" pattern="[0-9]*" minlength="4" maxlength="4" required autocomplete="new-password" disabled>
                    </div>
                    <div id="setup-error-message"></div>
                    <button type="submit" id="setup-pin-button" class="button-57 button-57-primary" role="button" disabled>
                        <span class="text"><i class="fas fa-save"></i> Set PIN</span>
                        <span class="sub-text">Confirm Setup</span>
                    </button>
                </form>
            </div>

            <!-- PIN Entry Section -->
            <div id="pin-entry-section" style="display: none;">
                <h2><i class="fas fa-lock"></i> Enter PIN</h2>
                <p>Enter the 4-digit PIN to unlock your secure vault.</p>
                <div class="pin-input-container" id="pin-container">
                    <!-- Inputs will be dynamically generated/managed by JS for better listener handling -->
                    <input type="password" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]*" required autocomplete="one-time-code" aria-label="PIN digit 1">
                    <input type="password" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]*" required autocomplete="one-time-code" aria-label="PIN digit 2">
                    <input type="password" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]*" required autocomplete="one-time-code" aria-label="PIN digit 3">
                    <input type="password" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]*" required autocomplete="one-time-code" aria-label="PIN digit 4">
                </div>
                <div id="pin-error-message"></div>
                 <!-- Optional: Add a subtle loading indicator near PIN inputs -->
                 <div id="pin-loading" style="display: none; margin-top: -1rem; margin-bottom: 1rem;">
                     <div class="spinner" style="width: 24px; height: 24px; border-width: 3px; margin: 0 auto;"></div>
                 </div>
            </div>
        </div>
    </div>

    <!-- Main Vault Content (Initially Hidden) -->
    <div id="vault-container" class="container"> <!-- Controlled by JS -->
        <header>
            <h1><i class="fas fa-shield-halved icon"></i> Vault</h1> <!-- Updated Icon -->
        </header>

        <section class="add-password-form">
             <div class="section-header"> <!-- Use section header structure -->
                <h2><i class="fas fa-plus-circle"></i> Add New Entry</h2>
             </div>
            <form id="password-form">
                <div class="form-group">
                    <label for="website-name">Website / Service Name</label>
                    <input type="text" id="website-name" required placeholder="e.g., My Awesome Service">
                </div>
                <div class="form-group">
                    <label for="username">Username / Email</label>
                    <input type="text" id="username" required placeholder="e.g., user@email.com">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="password" required placeholder="Enter secure password">
                        <button type="button" class="toggle-visibility" title="Show / Hide Password" aria-label="Toggle password visibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" class="button-57 button-57-primary" role="button">
                    <span class="text"><i class="fas fa-save"></i> Save Entry</span>
                    <span class="sub-text">Confirm Save</span>
                </button>
            </form>
        </section>

        <section class="password-list-section">
            <div class="section-header">
                <h2><i class="fas fa-list-ul"></i> Stored Entries</h2>
                <button id="export-button" class="button-57 button-57-export" role="button" title="Export all entries to a JSON file" disabled>
                    <span class="text"><i class="fas fa-download"></i> Export All</span>
                    <span class="sub-text">Download File</span>
                </button>
            </div>
             <div class="search-container">
                 <input type="text" id="search-input" placeholder="Search by website or username..." aria-label="Search stored entries">
                 <i class="fas fa-search search-icon"></i>
            </div>
            <ul id="password-list" class="password-list">
                <!-- Password entries dynamically loaded here -->
                 <li class="no-entries">
                     <i class="fas fa-spinner fa-spin"></i> <!-- Use Font Awesome spinner -->
                     <span class="visually-hidden">Loading entries...</span>
                 </li>
            </ul>
        </section>
    </div>

    <footer>
        <p>© 2025 Enhanced Vault Demo — Powered by Danav</p>
    </footer>


    <script>
        // --- Start Embedded JavaScript ---
        // (Backend interaction logic remains the same)

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
              .then(registration => {
                console.log('Service Worker registered successfully with scope:', registration.scope);
              })
              .catch(error => {
                console.error('Service Worker registration failed:', error);
              });
          });
        }

        document.addEventListener('DOMContentLoaded', () => {

            // --- Constants ---
            const MASKED_PASSWORD_CHAR = '••••••••';
            const API_BASE_URL = '/api'; // Adjust if needed

            // --- DOM Elements ---
            const loadingIndicator = document.getElementById('loading-indicator');
            const loginScreen = document.getElementById('login-screen');
            const pinSetupSection = document.getElementById('pin-setup-section');
            const pinEntrySection = document.getElementById('pin-entry-section');
            const pinSetupForm = document.getElementById('pin-setup-form');
            // Setup inputs remain for info display
            const pinContainer = document.getElementById('pin-container');
            let pinInputs = Array.from(pinContainer.querySelectorAll('.pin-digit')); // Use let as it will be updated
            const pinErrorMessage = document.getElementById('pin-error-message');
            const pinLoadingIndicator = document.getElementById('pin-loading');
            const vaultContainer = document.getElementById('vault-container');
            const passwordForm = document.getElementById('password-form');
            const websiteInput = document.getElementById('website-name');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const passwordList = document.getElementById('password-list');
            const togglePasswordButton = document.querySelector('.toggle-visibility');
            const searchInput = document.getElementById('search-input');
            const exportButton = document.getElementById('export-button');

            let allPasswordsCache = []; // Cache for client-side filtering
            let isVaultInitialized = false; // Flag to prevent multiple initializations

            // --- Utility Functions ---
            const showLoading = (show = true) => {
                loadingIndicator.style.display = show ? 'flex' : 'none';
            };
            const showPinLoading = (show = true) => {
                pinLoadingIndicator.style.display = show ? 'block' : 'none';
            };
            const escapeHtml = (unsafe) => {
                const str = String(unsafe || '');
                return str
                     .replace(/&/g, "&")
                     .replace(/</g, "<")
                     .replace(/>/g, ">")
                     .replace(/"/g, """)
                     .replace(/'/g, "'");
            };

            // --- Initialization ---
            checkAuthenticationStatus();

            // --- Login Logic ---
            async function checkAuthenticationStatus() {
                showLoading(true);
                try {
                    const response = await fetch(`${API_BASE_URL}/passwords.php`, { credentials: 'include' });
                    if (response.ok) {
                        await initializeVault(); // Initialize vault if authenticated
                        hideLoginScreen();
                        showVaultContainer();
                    } else if (response.status === 401) {
                        showLoginScreen();
                    } else {
                        console.error("Error checking auth status:", response.status, await response.text());
                        showLoginScreenWithError(`Server error (${response.status}) checking login status.`);
                    }
                } catch (error) {
                    console.error("Network error checking auth status:", error);
                    showLoginScreenWithError("Network error. Cannot reach server.");
                } finally {
                    showLoading(false);
                }
            }

            function showLoginScreen() {
                pinErrorMessage.textContent = '';
                pinInputs.forEach(input => { input.value = ''; input.classList.remove('error'); });
                loginScreen.classList.add('visible');
                pinSetupSection.style.display = 'none'; // Keep setup hidden by default
                pinEntrySection.style.display = 'block';
                vaultContainer.classList.remove('visible'); // Ensure vault is hidden
                vaultContainer.style.display = 'none'; // Use display none as well
                setupPinInputListeners(); // Re-attach listeners
                // Small delay for transition + focus
                setTimeout(() => pinInputs[0]?.focus(), 50);
            }

            function showLoginScreenWithError(message) {
                showLoginScreen();
                pinErrorMessage.textContent = message;
            }

            function hideLoginScreen() {
                 loginScreen.classList.remove('visible');
            }

            function showVaultContainer() {
                vaultContainer.style.display = 'block'; // Make it take space
                // Use timeout to allow display:block to apply before transition starts
                setTimeout(() => {
                    vaultContainer.classList.add('visible');
                }, 10); // Small delay
            }

            // PIN Setup Form Listener (Informational Only)
            pinSetupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                setupErrorMessage.textContent = "PIN setup must be done on the server using 'setup_pin.php' and then deleted.";
            });

            function setupPinInputListeners() {
                // Clear existing listeners by replacing nodes
                const newPinContainer = pinContainer.cloneNode(true);
                pinContainer.parentNode.replaceChild(newPinContainer, pinContainer);
                // Update references
                pinInputs = Array.from(newPinContainer.querySelectorAll('.pin-digit'));

                pinInputs.forEach((input, index) => {
                    input.addEventListener('input', () => handlePinInput(input, index));
                    input.addEventListener('keydown', (e) => handlePinKeydown(e, index));
                    input.addEventListener('focus', () => {
                        input.select();
                        input.classList.remove('error'); // Remove error state on focus
                    });
                    input.addEventListener('paste', (e) => handlePinPaste(e, index));
                });
            }

            function handlePinInput(input, index) {
                const value = input.value;
                pinErrorMessage.textContent = '';
                input.classList.remove('error'); // Remove error on input

                // Move focus forward
                if (value.length === 1 && /^\d$/.test(value) && index < pinInputs.length - 1) {
                    pinInputs[index + 1].focus();
                }

                // Check if all filled
                if (pinInputs.every(inp => inp.value.length === 1 && /^\d$/.test(inp.value))) {
                    submitPinForLogin();
                }
            }

            function handlePinKeydown(e, index) {
                // Move focus backward on backspace
                if (e.key === 'Backspace') {
                    // If current input is empty OR not empty, move back after clearing
                     pinInputs[index].value = ''; // Clear current first
                     if (index > 0) {
                         pinInputs[index - 1].focus();
                         pinInputs[index - 1].select(); // Select previous
                     }
                     e.preventDefault(); // Prevent default backspace behavior
                }

                // Allow only digits, Backspace, Tab, Arrow keys, Paste (Cmd/Ctrl+V), Select All (Cmd/Ctrl+A)
                if (!/^\d$/.test(e.key) &&
                    !['Backspace', 'Tab', 'ArrowLeft', 'ArrowRight', 'Delete', 'Home', 'End'].includes(e.key) &&
                    !(e.metaKey || e.ctrlKey) // Allow Cmd/Ctrl combinations
                   )
                {
                    e.preventDefault();
                }
            }

             function handlePinPaste(e, startIndex) {
                e.preventDefault();
                const pasteData = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g, ''); // Get only digits
                if (!pasteData) return;

                let currentDigit = 0;
                for (let i = startIndex; i < pinInputs.length && currentDigit < pasteData.length; i++) {
                    pinInputs[i].value = pasteData[currentDigit];
                    currentDigit++;
                    if (i < pinInputs.length - 1 && currentDigit < pasteData.length) {
                        // Don't move focus immediately, let loop handle it
                    } else if (i < pinInputs.length - 1 && currentDigit === pasteData.length) {
                         pinInputs[i + 1].focus(); // Move focus if paste ends before last input
                    }
                }
                 // Check if complete after paste
                 if (pinInputs.every(inp => inp.value.length === 1 && /^\d$/.test(inp.value))) {
                    submitPinForLogin();
                }
            }


            function getEnteredPin() {
                return pinInputs.map(input => input.value).join('');
            }

            async function submitPinForLogin() {
                const enteredPin = getEnteredPin();
                if (enteredPin.length !== 4) return;

                pinErrorMessage.textContent = '';
                showPinLoading(true);
                pinInputs.forEach(input => input.disabled = true); // Disable inputs during check

                try {
                    const response = await fetch(`${API_BASE_URL}/login.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ pin: enteredPin })
                    });

                    if (response.ok) {
                        await initializeVault(); // Ensure vault is ready
                        hideLoginScreen();
                        showVaultContainer();
                    } else {
                        const data = await response.json().catch(() => ({}));
                        handleIncorrectPin(data.error || `Login failed (Status: ${response.status})`);
                    }
                } catch (error) {
                    console.error('Login network error:', error);
                    handleIncorrectPin('Network error during login.');
                } finally {
                    showPinLoading(false);
                    pinInputs.forEach(input => input.disabled = false); // Re-enable inputs
                }
            }

            function handleIncorrectPin(message = 'Incorrect PIN. Please try again.') {
                pinErrorMessage.textContent = message;
                pinInputs.forEach(input => {
                    input.value = '';
                    input.classList.add('error'); // Add error class for styling
                });
                // Trigger reflow for animation restart if needed (though classList add/remove might suffice)
                pinContainer.classList.remove('shake');
                void pinContainer.offsetWidth; // Trigger reflow
                pinContainer.classList.add('shake');

                pinInputs[0].focus();

                // Remove shake animation class after it finishes
                setTimeout(() => {
                    pinContainer.classList.remove('shake');
                    // Optionally remove error class after a delay too
                    // setTimeout(() => pinInputs.forEach(input => input.classList.remove('error')), 2000);
                }, 500);
            }

            // --- Vault Logic ---
            async function initializeVault() {
                // Prevent multiple initializations
                if (isVaultInitialized) {
                    // If already initialized, just ensure data is fresh
                    await fetchAndRenderPasswords(searchInput.value);
                    return;
                }

                // Add Vault Event Listeners (only once)
                togglePasswordButton.addEventListener('click', handleTogglePasswordVisibility);
                passwordForm.addEventListener('submit', handleAddPassword);
                searchInput.addEventListener('input', handleSearch);
                passwordList.addEventListener('click', handleListActions);
                exportButton.addEventListener('click', handleExport);

                // Initial fetch and render of passwords
                await fetchAndRenderPasswords();
                isVaultInitialized = true; // Set flag
            }

            // --- Vault Event Handlers ---
            function handleTogglePasswordVisibility() {
                const icon = togglePasswordButton.querySelector('i');
                if (!icon) return;
                const isPassword = passwordInput.type === 'password';
                passwordInput.type = isPassword ? 'text' : 'password';
                icon.classList.toggle('fa-eye', !isPassword);
                icon.classList.toggle('fa-eye-slash', isPassword);
                togglePasswordButton.title = isPassword ? "Hide Password" : "Show Password";
                togglePasswordButton.setAttribute('aria-pressed', isPassword ? 'true' : 'false');
            }

            async function handleAddPassword(e) {
                e.preventDefault();
                const website = websiteInput.value.trim();
                const username = usernameInput.value.trim();
                const password = passwordInput.value;

                if (!website || !username || !password) {
                    alert('Please fill in all fields.');
                    return;
                }

                const saveButton = passwordForm.querySelector('button[type="submit"]');
                const originalButtonText = saveButton.querySelector('.text').innerHTML;
                saveButton.disabled = true;
                saveButton.querySelector('.text').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                try {
                    const response = await fetch(`${API_BASE_URL}/passwords.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ website, username, password })
                    });

                    if (response.ok) {
                        passwordForm.reset();
                        resetPasswordVisibilityToggle();
                        await fetchAndRenderPasswords(searchInput.value); // Re-fetch and render
                    } else {
                         const data = await response.json().catch(() => ({}));
                         alert(`Error adding entry: ${data.error || response.statusText}`);
                         if (response.status === 401) {
                             showLoginScreenWithError("Session expired. Please log in again.");
                         }
                    }
                } catch (error) {
                    console.error('Error adding password:', error);
                    alert('Network error while adding entry.');
                } finally {
                     saveButton.disabled = false;
                     saveButton.querySelector('.text').innerHTML = originalButtonText;
                }
            }

            function handleSearch(e) {
                renderPasswordsFromCache(e.target.value);
            }

            function handleListActions(e) {
                const target = e.target;
                const listItem = target.closest('li[data-id]');
                if (!listItem) return;

                const entryId = listItem.dataset.id;
                const entry = allPasswordsCache.find(p => p.id == entryId);
                if (!entry) return;

                // Toggle Password Visibility (Click on the masked value)
                const passwordValueSpan = target.closest('.password-value');
                if (passwordValueSpan) {
                    togglePasswordDisplay(passwordValueSpan, entry.password);
                    return;
                }

                // Copy Button
                const copyButton = target.closest('.button-57.btn-copy');
                if (copyButton) {
                    copyPassword(copyButton, entry.password);
                    return;
                }

                // Delete Button
                const deleteButton = target.closest('.button-57.btn-delete');
                if (deleteButton) {
                    if (confirm(`Are you sure you want to delete the entry for "${entry.website}"? This cannot be undone.`)) {
                        deletePasswordEntry(entryId, deleteButton); // Pass button for loading state
                    }
                    return;
                }
            }

            async function handleExport() {
                exportButton.disabled = true;
                const originalButtonText = exportButton.querySelector('.text').innerHTML;
                exportButton.querySelector('.text').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';

                try {
                    const passwordsToExport = await fetchPasswords(); // Fetch fresh data

                    if (passwordsToExport.length === 0) {
                        alert("There are no entries to export.");
                        return; // Exit early
                    }

                    // Confirmation Dialog
                    const proceed = confirm("⚠️ WARNING ⚠️\n\nYou are about to export your stored entries.\n\nThe downloaded file will contain your passwords in PLAIN TEXT and is NOT encrypted.\n\nPlease store this file securely and delete it when no longer needed.\n\nDo you want to proceed?");
                    if (!proceed) return; // Exit if user cancels

                    const jsonData = JSON.stringify(passwordsToExport, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const dateString = new Date().toISOString().split('T')[0];
                    a.download = `password_vault_export_${dateString}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                } catch (error) {
                     console.error("Error during export:", error);
                     alert(`An error occurred during export: ${error.message || 'Unknown error'}`);
                     if (error.message.includes("Session expired")) {
                         showLoginScreenWithError("Session expired. Please log in again to export.");
                     }
                } finally {
                    exportButton.disabled = allPasswordsCache.length === 0; // Re-enable based on cache
                    exportButton.querySelector('.text').innerHTML = originalButtonText;
                }
            }

            // --- Vault Core Functions ---
            async function fetchPasswords() {
                // No separate loading indicator here, handled by caller (initializeVault or handleExport)
                try {
                    const response = await fetch(`${API_BASE_URL}/passwords.php`, { credentials: 'include' });
                    if (response.ok) {
                        return await response.json();
                    } else {
                         if (response.status === 401) {
                             throw new Error("Session expired. Please log in again.");
                         }
                         const errorData = await response.json().catch(() => ({}));
                         console.error("Error fetching passwords:", response.status, errorData.error);
                         throw new Error(`Error fetching passwords: ${errorData.error || response.statusText}`);
                    }
                } catch (error) {
                    console.error('Network/Fetch error fetching passwords:', error);
                    // Re-throw specific errors or a generic one
                    if (error.message.includes("Session expired")) throw error;
                    throw new Error('Network error fetching passwords.');
                }
            }

            async function fetchAndRenderPasswords(filter = '') {
                // Show loading state in the list area
                passwordList.innerHTML = `<li class="no-entries"><div class="spinner"></div><span class="visually-hidden">Loading entries...</span></li>`;
                exportButton.disabled = true; // Disable export while loading

                try {
                    allPasswordsCache = await fetchPasswords();
                    renderPasswordsFromCache(filter);
                } catch (error) {
                     if (error.message.includes("Session expired")) {
                         showLoginScreenWithError(error.message);
                         passwordList.innerHTML = `<li class="no-entries"><i class="fas fa-exclamation-triangle"></i> Session expired. Please log in.</li>`;
                     } else {
                         passwordList.innerHTML = `<li class="no-entries"><i class="fas fa-exclamation-circle"></i> Error loading entries. ${escapeHtml(error.message)}</li>`;
                     }
                     allPasswordsCache = []; // Clear cache on error
                     exportButton.disabled = true;
                }
            }

            function renderPasswordsFromCache(filter = '') {
                passwordList.innerHTML = ''; // Clear previous entries
                const lowerCaseFilter = filter.toLowerCase().trim();

                const filteredPasswords = allPasswordsCache.filter(p =>
                    (p.website && p.website.toLowerCase().includes(lowerCaseFilter)) ||
                    (p.username && p.username.toLowerCase().includes(lowerCaseFilter))
                );

                exportButton.disabled = allPasswordsCache.length === 0;

                if (filteredPasswords.length === 0) {
                    const message = allPasswordsCache.length === 0
                        ? 'Your vault is empty. Add an entry using the form above!'
                        : 'No entries match your search.';
                    const iconClass = allPasswordsCache.length === 0 ? 'fa-box-open' : 'fa-search';
                    passwordList.innerHTML = `<li class="no-entries"><i class="fas ${iconClass}"></i> ${message}</li>`;
                } else {
                    // Sort alphabetically by website name
                    filteredPasswords.sort((a, b) => (a.website || '').localeCompare(b.website || ''));

                    filteredPasswords.forEach((entry, index) => {
                        const listItem = document.createElement('li');
                        listItem.dataset.id = entry.id;
                        // Add animation delay based on order
                        listItem.style.setProperty('--animation-order', index);
                        // Escape data before inserting into HTML
                        listItem.innerHTML = createPasswordListItemHTML({
                             ...entry,
                             website: escapeHtml(entry.website),
                             username: escapeHtml(entry.username)
                             // Password is not directly inserted here
                        });
                        passwordList.appendChild(listItem);
                    });
                }
            }

            function createPasswordListItemHTML(entry) {
                // Note: entry.password is NOT used here directly. It's passed to JS handlers.
                const escapedWebsite = entry.website || 'N/A';
                const escapedUsername = entry.username || 'N/A';

                return `
                    <div class="password-entry-details">
                        <strong>${escapedWebsite}</strong>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-user"></i> User:</span>
                            <span class="username-value">${escapedUsername}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-key"></i> Pass:</span>
                            <span class="password-value-container">
                                <span class="password-value" title="Click to reveal / hide password" aria-live="polite" aria-label="Password for ${escapedWebsite}, currently hidden">${MASKED_PASSWORD_CHAR}</span>
                            </span>
                        </div>
                    </div>
                    <div class="password-entry-actions">
                        <button class="button-57 button-57-secondary btn-copy" role="button" title="Copy Password to Clipboard" aria-label="Copy password for ${escapedWebsite}">
                            <span class="text"><i class="far fa-copy"></i> Copy</span>
                            <span class="sub-text">Copy Pass</span>
                        </button>
                        <button class="button-57 button-57-danger btn-delete" role="button" title="Delete this Entry" aria-label="Delete entry for ${escapedWebsite}">
                            <span class="text"><i class="far fa-trash-alt"></i> Delete</span>
                            <span class="sub-text">Remove</span>
                        </button>
                    </div>
                `;
            }

            function togglePasswordDisplay(element, actualPassword) {
                if (element.textContent === MASKED_PASSWORD_CHAR) {
                    element.textContent = escapeHtml(actualPassword); // Escape just before display
                    element.classList.add('visible');
                    element.setAttribute('aria-label', `Password for ${element.closest('.password-entry-details').querySelector('strong').textContent}, currently visible: ${escapeHtml(actualPassword)}`);
                } else {
                    element.textContent = MASKED_PASSWORD_CHAR;
                    element.classList.remove('visible');
                     element.setAttribute('aria-label', `Password for ${element.closest('.password-entry-details').querySelector('strong').textContent}, currently hidden`);
                }
            }

            async function copyPassword(buttonElement, password) {
                 const textSpan = buttonElement.querySelector('.text');
                 if (!textSpan || buttonElement.classList.contains('copied')) return; // Prevent double click issues

                 const originalTextHTML = textSpan.innerHTML;
                 const originalAriaLabel = buttonElement.getAttribute('aria-label');

                 buttonElement.classList.add('copied'); // Add class for styling (background change)
                 textSpan.innerHTML = '<i class="fas fa-check"></i> Copied!';
                 buttonElement.setAttribute('aria-label', 'Password copied to clipboard');


                 try {
                     await navigator.clipboard.writeText(password);
                     // Visual feedback duration
                     setTimeout(() => {
                         // Check element still exists before modifying
                         const currentTextSpan = buttonElement.querySelector('.text');
                         if (buttonElement && currentTextSpan) {
                              buttonElement.classList.remove('copied');
                              currentTextSpan.innerHTML = originalTextHTML;
                              buttonElement.setAttribute('aria-label', originalAriaLabel);
                         }
                     }, 1800);
                 } catch (err) {
                     console.error('Failed to copy password: ', err);
                     alert('Failed to copy password. Ensure you are using HTTPS or localhost.');
                      // Reset button state on error
                      const currentTextSpan = buttonElement.querySelector('.text');
                      if (buttonElement && currentTextSpan) {
                         buttonElement.classList.remove('copied');
                         currentTextSpan.innerHTML = originalTextHTML;
                         buttonElement.setAttribute('aria-label', originalAriaLabel);
                      }
                 }
            }

            async function deletePasswordEntry(id, buttonElement) {
                const originalButtonText = buttonElement.querySelector('.text').innerHTML;
                buttonElement.disabled = true;
                buttonElement.querySelector('.text').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting';

                try {
                    const response = await fetch(`${API_BASE_URL}/passwords.php?id=${id}`, {
                        method: 'DELETE',
                        headers: { 'Accept': 'application/json' },
                        credentials: 'include'
                    });

                    if (response.ok) {
                        // Animate removal
                        const listItem = buttonElement.closest('li[data-id]');
                        if (listItem) {
                            listItem.style.transition = 'opacity 0.3s ease, transform 0.3s ease, height 0.3s ease';
                            listItem.style.opacity = '0';
                            listItem.style.transform = 'translateX(-20px)';
                            listItem.style.height = '0';
                            listItem.style.paddingTop = '0';
                            listItem.style.paddingBottom = '0';
                            listItem.style.marginBottom = '0';
                            listItem.style.border = 'none';


                            setTimeout(() => {
                                // Remove from cache and re-render AFTER animation
                                allPasswordsCache = allPasswordsCache.filter(entry => entry.id != id);
                                renderPasswordsFromCache(searchInput.value); // Re-render to update list and potentially show "empty" message
                            }, 300); // Match animation duration
                        } else {
                             // Fallback if item not found (shouldn't happen)
                             allPasswordsCache = allPasswordsCache.filter(entry => entry.id != id);
                             renderPasswordsFromCache(searchInput.value);
                        }

                    } else {
                         const data = await response.json().catch(() => ({}));
                         alert(`Error deleting entry: ${data.error || response.statusText}`);
                          if (response.status === 401) {
                             showLoginScreenWithError("Session expired. Please log in again.");
                         }
                         // Reset button on error
                         buttonElement.disabled = false;
                         buttonElement.querySelector('.text').innerHTML = originalButtonText;
                    }
                } catch (error) {
                    console.error('Error deleting password:', error);
                    alert('Network error while deleting entry.');
                    // Reset button on error
                    buttonElement.disabled = false;
                    buttonElement.querySelector('.text').innerHTML = originalButtonText;
                }
                // Note: Button state is reset implicitly by re-rendering or explicitly on error.
            }

            function resetPasswordVisibilityToggle() {
                passwordInput.type = 'password';
                const icon = togglePasswordButton.querySelector('i');
                 if (icon) {
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                    togglePasswordButton.title = "Show Password";
                    togglePasswordButton.setAttribute('aria-pressed', 'false');
                 }
            }

        }); // End DOMContentLoaded

        // --- End Embedded JavaScript ---
    </script>

</body>
</html>
