<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Favicon Link -->
    <link rel="icon" type="image/png" href="https://i.ibb.co/7JfMHZQj/vault.png">

    <!-- PWA Manifest Link (Ensure manifest.json exists at the root) -->
    <link rel="manifest" href="manifest.json">

    <!-- PWA Theme color -->
    <meta name="theme-color" content="#5480ca">

    <!-- Add to home screen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Local Vault">
    <!-- Optional: Add Apple touch icons if needed -->
    <!-- <link rel="apple-touch-icon" href="icons/apple-touch-icon.png"> -->

    <title>Vault</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- Start Embedded CSS --- */

        /* --- Variables & Base --- */
        :root {
            --primary-color: #5480ca; /* Cool Blue */
            --secondary-color: #4fc3b4; /* Teal */
            --tertiary-color: #f39c12; /* Orange */
            /* Background variables are no longer used for body, but kept for potential elements */
            --background-start: #eef4f8;
            --background-end: #f8f0fc;
            --card-background: #ffffff;
            --text-color: #34495e; /* Dark Slate Gray */
            --text-muted: #7f8c8d; /* Grayish Blue */
            --border-color: #e0e0e0; /* Light Gray */
            --danger-color: #e74c3c; /* Red */
            --success-color: #2ecc71; /* Green */
            --font-family: 'Poppins', sans-serif;
            --border-radius: 10px;
            --base-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --hover-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            --transition-speed: 0.3s;

            /* Button 57 Specific Colors */
            --btn57-dark: #18181a;
            --btn57-light: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* --- New Animated Background CSS --- */
        html {
          height:100%; /* Needed for fixed background positioning */
          font-size: 16px;
          scroll-behavior: smooth;
        }

        body {
          margin:0; /* From new background CSS */
          font-family: var(--font-family);
          color: var(--text-color);
          line-height: 1.7;
          display: flex;
          flex-direction: column;
          min-height: 100vh;
          /* REMOVED old background gradient and animation */
          overflow-x: hidden; /* Keep to prevent horizontal scroll */
        }

        .bg {
          animation:slide 8s ease-in-out infinite alternate; /* Slower animation */
          /* Updated gradient using theme colors */
          background-image: linear-gradient(-60deg, var(--secondary-color) 50%, var(--primary-color) 50%);
          bottom:0;
          left:-50%;
          opacity:.4; /* Slightly less opaque */
          position:fixed;
          right:-50%;
          top:0;
          z-index:-1; /* Ensure it's behind content */
        }

        .bg2 {
          animation-direction:alternate-reverse;
          animation-duration:10s; /* Different duration */
           /* Different gradient */
          background-image: linear-gradient(-60deg, var(--tertiary-color) 50%, var(--secondary-color) 50%);
          opacity: 0.3;
        }

        .bg3 {
          animation-duration:12s; /* Different duration */
           /* Different gradient */
          background-image: linear-gradient(-60deg, var(--primary-color) 50%, #a8bfe4 50%); /* Primary to lighter blue */
          opacity: 0.35;
        }

        @keyframes slide {
          0% {
            transform:translateX(-25%);
          }
          100% {
            transform:translateX(25%);
          }
        }
        /* --- End New Animated Background CSS --- */


        /* --- Login Screen Styles --- */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* This background sits OVER the new animated .bg divs */
            background: rgba(238, 244, 248, 0.85); /* Slightly less opaque to see background more */
            backdrop-filter: blur(10px); /* Increased blur */
            -webkit-backdrop-filter: blur(10px); /* Safari support */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000; /* High z-index to be on top */
            padding: 1rem;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
            opacity: 0;
            visibility: hidden;
        }

        #login-screen.visible {
             opacity: 1;
             visibility: visible;
        }

        .login-container {
            /* This container remains opaque */
            background-color: var(--card-background);
            padding: 2.5rem 3rem;
            border-radius: var(--border-radius);
            box-shadow: var(--hover-shadow);
            text-align: center;
            max-width: 420px;
            width: 100%;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s ease-out;
            position: relative; /* Ensure it has a stacking context above z-index -1 */
            z-index: 1; /* Explicitly above background */
        }
        #login-screen.visible .login-container {
            transform: scale(1);
            opacity: 1;
        }

        .login-container h2 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.8rem;
            font-weight: 600;
        }
        .login-container h2 i {
            margin-right: 0.6rem;
            vertical-align: middle;
        }

        .login-container p {
            color: var(--text-muted);
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        #pin-entry-section, #pin-setup-section {
             margin-bottom: 1.5rem;
        }

        .pin-input-container {
            display: flex;
            justify-content: center;
            gap: 15px; /* Increased gap */
            margin-bottom: 1.5rem;
        }

        .pin-digit {
            width: 55px; /* Slightly wider */
            height: 65px; /* Slightly taller */
            font-size: 2rem;
            text-align: center;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: #f8f9fa; /* Lighter background */
            color: var(--text-color);
            caret-color: var(--primary-color);
            transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease, transform 0.1s ease;
            -moz-appearance: textfield; /* Hide spinners */
            appearance: textfield;
            line-height: 61px; /* Adjust line height */
            font-weight: 600; /* Make digits bolder */
        }
        .pin-digit::-webkit-outer-spin-button,
        .pin-digit::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .pin-digit:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(84, 128, 202, 0.25);
            transform: scale(1.05); /* Scale up on focus */
        }

        #pin-error-message {
            color: var(--danger-color);
            min-height: 1.2em;
            margin-top: -1rem; /* Pull up slightly */
            margin-bottom: 1rem;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex; /* Use flex for icon alignment */
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* Space between icon and text */
        }
        /* Add icon using ::before pseudo-element */
        #pin-error-message:not(:empty)::before {
            content: "\f071"; /* Font Awesome exclamation-triangle */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            display: inline-block;
        }

        /* Shake animation for incorrect PIN */
        @keyframes shake {
          10%, 90% { transform: translateX(-1px); }
          20%, 80% { transform: translateX(2px); }
          30%, 50%, 70% { transform: translateX(-4px); }
          40%, 60% { transform: translateX(4px); }
        }
        .shake {
          animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* PIN Setup Section - Keep informational, disable form */
        #pin-setup-section .form-group { margin-bottom: 1rem; text-align: left; }
        #pin-setup-section label { display: block; margin-bottom: 0.4rem; font-weight: 600; color: var(--text-muted); font-size: 0.85rem; }
        #pin-setup-section input[type="password"] { width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 1rem; background-color: #e9ecef; cursor: not-allowed; } /* Disabled style */
        #pin-setup-section input[type="password"]:focus { outline: none; border-color: var(--border-color); box-shadow: none; } /* No focus style */
        #setup-pin-button { margin-top: 1rem; width: 100%; }
        #setup-error-message { color: var(--danger-color); min-height: 1.2em; margin-top: 0.5rem; font-weight: 600; font-size: 0.9rem; }


        /* --- Vault Container --- */
        #vault-container {
            display: none; /* Initially hidden */
            width: 100%;
            max-width: 900px; /* Max width */
            margin: 3rem auto; /* Centered with top/bottom margin */
            padding: 2.5rem 3rem;
            /* This container remains opaque */
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--base-shadow);
            flex-grow: 1; /* Takes up remaining vertical space */
            transition: box-shadow var(--transition-speed) ease, opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            opacity: 0;
            transform: translateY(20px); /* Start slightly lower */
            position: relative; /* Ensure it has a stacking context */
            z-index: 1; /* Explicitly above background */
        }
        #vault-container.visible {
            opacity: 1;
            transform: translateY(0); /* Animate to final position */
        }
        #vault-container:hover {
             box-shadow: var(--hover-shadow); /* Enhanced shadow on hover */
        }

        /* --- Header --- */
        header { text-align: center; margin-bottom: 3rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
        header h1 { color: var(--primary-color); margin-bottom: 0; font-weight: 600; font-size: 2.2rem; word-break: break-word; }
        header h1 .icon { margin-right: 0.75rem; vertical-align: middle; font-size: 2rem; }

        /* --- Sections & Headings --- */
        .add-password-form,
        .password-list-section {
            margin-bottom: 3rem;
            padding: 2rem 2.5rem;
            /* These inner sections remain opaque */
            background-color: #fcfdff; /* Slightly off-white background */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* Subtle inner shadow */
        }

        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1.5rem; }
        h2 { color: var(--primary-color); font-weight: 600; font-size: 1.6rem; display: inline-flex; align-items: center; gap: 0.7rem; margin-right: 1rem; flex-shrink: 0; margin-bottom: 0; /* Remove default margin */ border-bottom: none; padding-bottom: 0; /* Remove default padding */ }
        #vault-container h2 { border-bottom: none; padding-bottom: 0; } /* Override any potential global h2 styles */


        /* --- Forms --- */
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.6rem; font-weight: 600; color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-group input[type="text"],
        .form-group input[type="password"],
        .search-container input[type="text"] { width: 100%; padding: 0.9rem 1.1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 1rem; font-family: inherit; color: var(--text-color); background-color: #fff; transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }
        .form-group input::placeholder,
        .search-container input::placeholder { color: #bbb; }
        .form-group input:focus,
        .search-container input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(84, 128, 202, 0.2); }
        .password-input-wrapper { position: relative; display: flex; align-items: center; }
        .password-input-wrapper input { padding-right: 3.5rem; } /* Space for the button */
        .toggle-visibility { position: absolute; right: 1px; top: 1px; bottom: 1px; width: 3.2rem; background: transparent; border: none; border-left: 1px solid var(--border-color); border-radius: 0 var(--border-radius) var(--border-radius) 0; cursor: pointer; color: var(--text-muted); font-size: 1.1rem; transition: color var(--transition-speed) ease, background-color var(--transition-speed) ease; display: flex; align-items: center; justify-content: center; }
        .toggle-visibility:hover { color: var(--primary-color); background-color: #f0f5fa; }
        .toggle-visibility i { pointer-events: none; } /* Ensure icon doesn't block clicks */

        /* --- Button 57 Styles (Refined) --- */
        .button-57 { position: relative; overflow: hidden; border: 1px solid var(--btn57-dark); color: var(--btn57-dark); display: inline-block; font-size: 15px; line-height: 1; padding: 16px 20px 15px; text-decoration: none; cursor: pointer; background: var(--btn57-light); user-select: none; -webkit-user-select: none; touch-action: manipulation; border-radius: var(--border-radius); font-family: inherit; font-weight: 600; margin: 5px; vertical-align: middle; text-align: center; transition: all var(--transition-speed) ease; }
        .button-57 .text { position: relative; transition: color 600ms cubic-bezier(0.48, 0, 0.12, 1); z-index: 10; display: inline-flex; align-items: center; justify-content: center; width: 100%; gap: 0.6rem; } /* Added gap for icon */
        .button-57 span:last-child { color: var(--btn57-light); display: block; position: absolute; bottom: 0; transition: all 500ms cubic-bezier(0.48, 0, 0.12, 1); z-index: 100; opacity: 0; top: 50%; left: 50%; transform: translateY(225%) translateX(-50%); height: 14px; line-height: 13px; white-space: nowrap; }
        .button-57:after { content: ""; position: absolute; bottom: -50%; left: 0; width: 100%; height: 100%; background-color: var(--btn57-dark); transform-origin: bottom center; transition: transform 600ms cubic-bezier(0.48, 0, 0.12, 1); transform: skewY(9.3deg) scaleY(0); z-index: 50; border-radius: inherit; }
        .button-57:hover:not(:disabled):after { transform-origin: bottom center; transform: skewY(9.3deg) scaleY(2); }
        .button-57:hover:not(:disabled) span:last-child { transform: translateX(-50%) translateY(-100%); opacity: 1; transition: all 900ms cubic-bezier(0.48, 0, 0.12, 1); }
        /* Disabled State */
        .button-57:disabled { opacity: 0.6; cursor: not-allowed; }
        .button-57:disabled:after { transform: skewY(9.3deg) scaleY(0); } /* Ensure no background fill when disabled */
        .button-57:disabled span:last-child { opacity: 0; } /* Hide hover text when disabled */
        /* Primary Button */
        .button-57-primary { border-color: var(--primary-color); color: var(--primary-color); }
        .button-57-primary:after { background-color: var(--primary-color); }
        .button-57-primary:hover:not(:disabled) .text { color: var(--btn57-light); }
        /* Secondary Button (Copy) */
        .button-57-secondary { border-color: var(--secondary-color); color: var(--secondary-color); padding: 10px 14px 9px; font-size: 14px; }
        .button-57-secondary:after { background-color: var(--secondary-color); }
        .button-57-secondary:hover:not(:disabled) .text { color: var(--btn57-dark); } /* Dark text on hover */
        .button-57-secondary span:last-child { color: var(--btn57-dark); } /* Dark hover text */
        /* Copied State for Secondary Button */
        .button-57-secondary.copied { border-color: var(--success-color); color: var(--btn57-light); background-color: var(--success-color); }
        .button-57-secondary.copied:after { transform: skewY(9.3deg) scaleY(0); } /* No hover fill when copied */
        .button-57-secondary.copied span:last-child { opacity: 0; } /* No hover text when copied */
        .button-57-secondary.copied:disabled { background-color: var(--success-color); color: var(--btn57-light); opacity: 0.7; } /* Keep style when disabled */
        /* Danger Button (Delete) */
        .button-57-danger { border-color: var(--danger-color); color: var(--danger-color); padding: 10px 14px 9px; font-size: 14px; }
        .button-57-danger:after { background-color: var(--danger-color); }
        .button-57-danger:hover:not(:disabled) .text { color: var(--btn57-light); }
        /* Export Button */
        .button-57-export { border-color: var(--tertiary-color); color: var(--tertiary-color); }
        .button-57-export:after { background-color: var(--tertiary-color); }
        .button-57-export:hover:not(:disabled) .text { color: var(--btn57-light); }

        /* --- Password List --- */
        .search-container { position: relative; margin-bottom: 2rem; }
        .search-container input { padding-left: 3rem; } /* Space for icon */
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 1.1rem; pointer-events: none; }
        .password-list { list-style: none; padding: 0; }
        .password-list li { background-color: var(--card-background); border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 1.2rem; padding: 1.5rem 2rem; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1.5rem; box-shadow: var(--base-shadow); transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }
        .password-list li:hover { transform: translateY(-5px) scale(1.015); /* Lift effect */ box-shadow: var(--hover-shadow); }
        /* Empty / Loading / No Results State */
        .password-list li.no-entries { text-align: center; color: var(--text-muted); padding: 3rem 2rem; font-style: italic; justify-content: center; border: 2px dashed var(--border-color); background-color: rgba(249, 250, 251, 0.9); /* Slightly transparent */ box-shadow: none; transform: none; flex-direction: column; gap: 1rem; font-size: 1.1rem; }
        .password-list li.no-entries::before { content: "\f52d"; /* Font Awesome box-open */ font-family: "Font Awesome 6 Free"; font-weight: 900; font-size: 2.5rem; color: var(--border-color); }
        .password-list li.no-entries:hover { transform: none; box-shadow: none; background-color: rgba(247, 248, 250, 0.95); } /* Subtle hover */
        /* Password Entry Details */
        .password-entry-details { flex-grow: 1; min-width: 250px; /* Prevent excessive shrinking */ overflow-wrap: break-word; word-wrap: break-word; word-break: break-word; }
        .password-entry-details strong { color: var(--primary-color); display: block; font-size: 1.3rem; font-weight: 600; margin-bottom: 0.75rem; }
        .password-entry-details .detail-item { margin-bottom: 0.5rem; font-size: 1rem; color: var(--text-color); display: flex; align-items: flex-start; /* Align items at the start */ gap: 0.8rem; }
        .detail-item .label { font-weight: 600; color: var(--text-muted); min-width: 60px; /* Ensure labels align */ font-size: 0.9rem; flex-shrink: 0; display: inline-flex; align-items: center; gap: 0.4rem; }
        .detail-item .label i { width: 1em; text-align: center; } /* Icon alignment */
        .detail-item .username-value,
        .detail-item .password-value-container { flex-grow: 1; min-width: 0; /* Allow shrinking */ line-height: 1.5; }
        /* Password Value Styling */
        .password-value { font-family: 'Courier New', Courier, monospace; cursor: pointer; display: inline-block; background-color: #ecf0f1; /* Light gray background */ padding: 0.2rem 0.6rem; border-radius: 5px; user-select: none; /* Prevent selection when masked */ transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; line-height: 1.4; word-break: break-all; /* Break long passwords */ }
        .password-value:hover { background-color: #dfe6e9; /* Darker gray on hover */ }
        .password-value.visible { background-color: transparent; /* No background when visible */ padding: 0.2rem 0; /* Adjust padding */ user-select: text; /* Allow selection when visible */ color: var(--success-color); /* Green color */ font-weight: 600; }
        /* Action Buttons Container */
        .password-entry-actions { display: flex; align-items: center; justify-content: flex-end; flex-shrink: 0; gap: 0.6rem; }

        /* --- Footer --- */
        footer {
            text-align: center;
            margin-top: auto; /* Push to bottom */
            padding: 1.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
            /* Make footer slightly transparent to see background */
            background-color: rgba(255, 255, 255, 0.8);
            border-top: 1px solid var(--border-color);
            width: 100%;
            position: relative; /* Ensure stacking context */
            z-index: 1; /* Above background */
        }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            #vault-container { margin: 1.5rem 1rem; padding: 2rem 1.5rem; }
            .login-container { padding: 2rem 1.5rem; max-width: 380px; }
            .pin-digit { width: 50px; height: 60px; font-size: 1.8rem; line-height: 56px; }
            .pin-input-container { gap: 10px; }
            header h1 { font-size: 1.9rem; }
            .section-header { margin-bottom: 1.5rem; padding-bottom: 1rem; gap: 1rem; }
            h2 { font-size: 1.4rem; gap: 0.6rem; }
            .section-header .button-57-export { width: 100%; margin: 0.5rem 0 0 0; } /* Stack export button */
            #password-form .button-57-primary { width: 100%; margin: 0; } /* Full width save button */
            .password-list li { flex-direction: column; align-items: stretch; padding: 1.2rem 1.5rem; gap: 1.2rem; }
            .password-list li:hover { transform: translateY(-3px); scale: 1; } /* Less pronounced hover on mobile */
            .password-entry-details { width: 100%; min-width: auto; }
            .password-entry-actions { width: 100%; justify-content: flex-end; gap: 0.5rem; }
            .button-57-secondary, .button-57-danger { padding: 9px 12px 8px; font-size: 13px; }
        }

        @media (max-width: 480px) {
            html { font-size: 15px; }
            #vault-container { margin: 1rem 0.5rem; padding: 1.5rem 1rem; border-radius: 8px; }
            .login-container { padding: 1.5rem 1rem; max-width: 95%; }
            .pin-digit { width: 45px; height: 55px; font-size: 1.6rem; line-height: 51px; }
            .pin-input-container { gap: 8px; }
            .add-password-form, .password-list-section { padding: 1.5rem 1rem; }
            header { margin-bottom: 2rem; padding-bottom: 1rem; }
            header h1 { font-size: 1.7rem; }
            header h1 .icon { font-size: 1.5rem; }
            .section-header { margin-bottom: 1.5rem; gap: 0.8rem; padding-bottom: 1rem;}
            h2 { font-size: 1.3rem; gap: 0.5rem; }
            .button-57 { font-size: 14px; padding: 14px 16px 13px; margin: 3px; } /* Adjust base button padding */
            .button-57-secondary, .button-57-danger { font-size: 13px; padding: 9px 10px 8px; } /* Adjust small button padding */
            .button-57-export, #password-form .button-57-primary, #setup-pin-button { font-size: 14px; padding: 14px 16px 13px; } /* Ensure consistent padding */
            .password-entry-details strong { font-size: 1.15rem; margin-bottom: 0.6rem; }
            .password-entry-details .detail-item { font-size: 0.95rem; gap: 0.5rem; margin-bottom: 0.4rem;}
            .detail-item .label { min-width: 55px; font-size: 0.85rem; gap: 0.3rem;}
            .password-list li { padding: 1rem 1.2rem; gap: 1rem; }
            .password-list li.no-entries { padding: 2rem 1rem; font-size: 1rem; }
            .password-list li.no-entries::before { font-size: 2rem; }
            .search-container input { padding-left: 2.5rem; }
            .search-icon { left: 0.8rem; font-size: 1rem; }
            footer { padding: 1rem; font-size: 0.85rem; }
        }
        /* --- End Embedded CSS --- */
    </style>
</head>
<body>

    <!-- NEW Animated Background DIVs -->
    <div class="bg"></div>
    <div class="bg bg2"></div>
    <div class="bg bg3"></div>

    <!-- Login Screen (Sits on top of the background) -->
    <div id="login-screen">
        <div class="login-container">
            <!-- PIN Setup Section (Informational) -->
            <div id="pin-setup-section" style="display: none;">
                <h2><i class="fas fa-user-shield"></i> Set Up Your PIN</h2>
                <p>PIN setup must be done via the server-side `setup_pin.php` script. Contact the administrator if a PIN needs to be set or reset.</p>
                <!-- Form is present but disabled to avoid confusion -->
                <form id="pin-setup-form">
                    <div class="form-group">
                        <label for="new-pin">Enter 4-Digit PIN</label>
                        <input type="password" id="new-pin" inputmode="numeric" pattern="[0-9]*" minlength="4" maxlength="4" required autocomplete="new-password" disabled>
                    </div>
                    <div class="form-group">
                        <label for="confirm-pin">Confirm PIN</label>
                        <input type="password" id="confirm-pin" inputmode="numeric" pattern="[0-9]*" minlength="4" maxlength="4" required autocomplete="new-password" disabled>
                    </div>
                    <div id="setup-error-message"></div>
                    <button type="submit" id="setup-pin-button" class="button-57 button-57-primary" role="button" disabled>
                        <span class="text"><i class="fas fa-save"></i> Set PIN</span>
                        <span>Confirm Setup</span>
                    </button>
                </form>
            </div>

            <!-- PIN Entry Section -->
            <div id="pin-entry-section" style="display: none;">
                <h2><i class="fas fa-lock"></i> Enter PIN</h2>
                <p>Enter the 4-digit PIN to unlock the vault.</p>
                <div class="pin-input-container" id="pin-container">
                    <!-- Inputs will be dynamically handled by JS for event listeners -->
                    <input type="password" class="pin-digit" id="pin-1" maxlength="1" inputmode="numeric" pattern="[0-9]*" required autocomplete="one-time-code">
                    <input type="password" class="pin-digit" id="pin-2" maxlength="1" inputmode="numeric" pattern="[0-9]*" required autocomplete="one-time-code">
                    <input type="password" class="pin-digit" id="pin-3" maxlength="1" inputmode="numeric" pattern="[0-9]*" required autocomplete="one-time-code">
                    <input type="password" class="pin-digit" id="pin-4" maxlength="1" inputmode="numeric" pattern="[0-9]*" required autocomplete="one-time-code">
                </div>
                <div id="pin-error-message"></div> <!-- Error message container -->
            </div>
        </div>
    </div>

    <!-- Main Vault Content (Sits on top of the background) -->
    <div id="vault-container" class="container"> <!-- Removed container class, handled by ID -->
        <header>
            <h1><i class="fas fa-shield-alt icon"></i> Vault</h1>
        </header>

        <section class="add-password-form">
            <h2><i class="fas fa-plus-circle"></i> Add New Entry</h2>
            <form id="password-form">
                <div class="form-group">
                    <label for="website-name">Website / Service Name</label>
                    <input type="text" id="website-name" required placeholder="e.g., My Favorite Website">
                </div>
                <div class="form-group">
                    <label for="username">Username / Email</label>
                    <input type="text" id="username" required placeholder="e.g., user@email.com">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="password" required placeholder="Enter your password">
                        <button type="button" class="toggle-visibility" title="Show / Hide Password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" class="button-57 button-57-primary" role="button">
                    <span class="text"><i class="fas fa-save"></i> Save Entry</span>
                    <span>Confirm Save</span>
                </button>
            </form>
        </section>

        <section class="password-list-section">
            <div class="section-header">
                <h2><i class="fas fa-list-ul"></i> Stored Entries</h2>
                <button id="export-button" class="button-57 button-57-export" role="button" title="Export all entries to a JSON file" disabled>
                    <span class="text"><i class="fas fa-download"></i> Export All</span>
                    <span>Download File</span>
                </button>
            </div>
             <div class="search-container">
                 <i class="fas fa-search search-icon"></i>
                 <input type="text" id="search-input" placeholder="Search by website or username...">
            </div>
            <ul id="password-list" class="password-list">
                 <!-- Initial state -->
                 <li class="no-entries">Loading entries...</li>
            </ul>
        </section>
    </div>

    <!-- Footer (Sits on top of the background) -->
    <footer>
        <p>© 2025 Enhanced Vault Demo — Powered by Danav</p>
    </footer>


    <script>
        // --- Start Embedded JavaScript ---

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js') // Ensure sw.js is at the root
              .then(registration => {
                console.log('Service Worker registered successfully with scope:', registration.scope);
              })
              .catch(error => {
                console.error('Service Worker registration failed:', error);
              });
          });
        }

        document.addEventListener('DOMContentLoaded', () => {

            const MASKED_PASSWORD_CHAR = '••••••••';
            const API_BASE_URL = '/api'; // Adjust if your API is elsewhere

            // Element References
            const loginScreen = document.getElementById('login-screen');
            const pinSetupSection = document.getElementById('pin-setup-section');
            const pinEntrySection = document.getElementById('pin-entry-section');
            const pinSetupForm = document.getElementById('pin-setup-form');
            const setupErrorMessage = document.getElementById('setup-error-message');
            const pinContainer = document.getElementById('pin-container');
            let pinInputs = Array.from(pinContainer.querySelectorAll('.pin-digit')); // Initial grab
            const pinErrorMessage = document.getElementById('pin-error-message');
            const vaultContainer = document.getElementById('vault-container');
            const passwordForm = document.getElementById('password-form');
            const websiteInput = document.getElementById('website-name');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const passwordList = document.getElementById('password-list');
            const togglePasswordButton = document.querySelector('.toggle-visibility');
            const searchInput = document.getElementById('search-input');
            const exportButton = document.getElementById('export-button');

            // Initial Check
            checkAuthenticationStatus();

            // --- Authentication Flow ---

            async function checkAuthenticationStatus() {
                try {
                    // Use HEAD request for efficiency if backend supports it for auth check
                    const response = await fetch(`${API_BASE_URL}/passwords.php`, { method: 'HEAD', credentials: 'include' });

                    if (response.ok || response.status === 405) { // 405 Method Not Allowed might mean auth is OK but HEAD isn't supported for GET route
                         // Double check with a GET if HEAD failed but wasn't 401
                         const getResponse = await fetch(`${API_BASE_URL}/passwords.php`, { credentials: 'include' });
                         if (getResponse.ok) {
                            showVault();
                         } else if (getResponse.status === 401) {
                            showLoginScreen();
                         } else {
                            console.error("Error checking auth status (GET):", getResponse.status, await getResponse.text());
                            showLoginScreenWithError(`Server error (${getResponse.status}) checking login status.`);
                         }
                    } else if (response.status === 401) { // Unauthorized
                        showLoginScreen();
                    } else {
                        console.error("Error checking auth status (HEAD):", response.status, await response.text());
                        showLoginScreenWithError(`Server error (${response.status}) checking login status.`);
                    }
                } catch (error) {
                    console.error("Network error checking auth status:", error);
                    showLoginScreenWithError("Network error. Cannot reach server.");
                }
            }

            function showLoginScreen() {
                pinErrorMessage.textContent = ''; // Clear previous errors
                pinInputs.forEach(input => input.value = ''); // Clear PIN fields
                loginScreen.classList.add('visible');
                pinSetupSection.style.display = 'none'; // Hide setup info initially
                pinEntrySection.style.display = 'block'; // Show PIN entry
                vaultContainer.style.display = 'none'; // Hide vault
                vaultContainer.classList.remove('visible');
                setupPinInputListeners(); // Re-attach listeners
                // Small delay ensures transition works and focus is set correctly
                setTimeout(() => pinInputs[0]?.focus(), 50);
            }

             function showLoginScreenWithError(message) {
                showLoginScreen();
                pinErrorMessage.textContent = message;
            }

            function showVault() {
                loginScreen.classList.remove('visible');
                // Delay showing vault slightly for smoother transition out of login
                setTimeout(() => {
                    vaultContainer.style.display = 'block';
                    // Use requestAnimationFrame to ensure display:block is applied before adding class
                    requestAnimationFrame(() => {
                        vaultContainer.classList.add('visible');
                    });
                    initializeVault(); // Initialize vault functions only when shown
                }, 100); // Adjust timing as needed
            }

            // --- PIN Setup (Informational Only) ---
            pinSetupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                // Reiterate that setup is server-side
                setupErrorMessage.textContent = "PIN setup must be done on the server using 'setup_pin.php' and then deleted.";
            });

            // --- PIN Entry Logic ---
            function setupPinInputListeners() {
                // Remove old listeners before adding new ones to prevent duplicates
                pinInputs.forEach(input => {
                    const oldInput = input;
                    const newInput = oldInput.cloneNode(true);
                    oldInput.parentNode.replaceChild(newInput, oldInput);
                });

                // Get the new set of inputs and add listeners
                pinInputs = Array.from(pinContainer.querySelectorAll('.pin-digit'));
                pinInputs.forEach((input, index) => {
                    input.addEventListener('input', () => handlePinInput(input, index));
                    input.addEventListener('keydown', (e) => handlePinKeydown(e, index));
                    input.addEventListener('focus', () => input.select()); // Select content on focus
                });
            }

            function handlePinInput(input, index) {
                const value = input.value;
                pinErrorMessage.textContent = ''; // Clear error on input
                pinContainer.classList.remove('shake'); // Remove shake on input

                // Basic validation: allow only single digits
                if (!/^\d?$/.test(value)) {
                    input.value = '';
                    return;
                }

                // Move focus to next input if a digit is entered
                if (value.length === 1 && index < pinInputs.length - 1) {
                    pinInputs[index + 1].focus();
                }

                // Check if all inputs are filled
                if (pinInputs.every(inp => inp.value.length === 1 && /^\d$/.test(inp.value))) {
                    submitPinForLogin();
                }
            }

            function handlePinKeydown(e, index) {
                // Move focus backward on Backspace if current input is empty
                if (e.key === 'Backspace' && index > 0 && pinInputs[index].value === '') {
                    pinInputs[index - 1].focus();
                }
                // Allow navigation keys, delete, numbers, backspace, tab
                if (!/^\d$/.test(e.key) && !['Backspace', 'Tab', 'ArrowLeft', 'ArrowRight', 'Delete', 'Home', 'End'].includes(e.key) && !e.metaKey && !e.ctrlKey) {
                    e.preventDefault(); // Prevent non-numeric input
                }
            }

            function getEnteredPin() {
                return pinInputs.map(input => input.value).join('');
            }

            async function submitPinForLogin() {
                const enteredPin = getEnteredPin();
                if (enteredPin.length !== 4) return; // Should not happen with current logic, but safety check

                pinErrorMessage.textContent = 'Checking PIN...';
                pinInputs.forEach(input => input.disabled = true); // Disable inputs during check

                try {
                    const response = await fetch(`${API_BASE_URL}/login.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        credentials: 'include', // Send session cookies
                        body: JSON.stringify({ pin: enteredPin })
                    });

                    if (response.ok) {
                        showVault(); // Transition to vault view
                    } else {
                        const data = await response.json().catch(() => ({})); // Try to parse error
                        handleIncorrectPin(data.error || `Login failed (Status: ${response.status})`);
                    }
                } catch (error) {
                    console.error('Login network error:', error);
                    handleIncorrectPin('Network error during login.');
                } finally {
                     pinInputs.forEach(input => input.disabled = false); // Re-enable inputs
                }
            }

            function handleIncorrectPin(message = 'Incorrect PIN. Please try again.') {
                pinErrorMessage.textContent = message;
                pinContainer.classList.add('shake'); // Trigger shake animation
                pinInputs.forEach(input => input.value = ''); // Clear inputs
                pinInputs[0].focus(); // Focus first input
                // Remove shake class after animation finishes
                setTimeout(() => { pinContainer.classList.remove('shake'); }, 500);
            }

            // --- Vault Initialization and Functionality ---

            function initializeVault() {
                // Prevent multiple initializations
                if (vaultContainer.dataset.initialized === 'true') return;
                vaultContainer.dataset.initialized = 'true';

                // Attach event listeners for vault elements
                togglePasswordButton.addEventListener('click', handleTogglePasswordVisibility);
                passwordForm.addEventListener('submit', handleAddPassword);
                searchInput.addEventListener('input', handleSearch);
                passwordList.addEventListener('click', handleListActions); // Use event delegation
                exportButton.addEventListener('click', handleExport);

                // Initial fetch of passwords
                fetchAndRenderPasswords();
            }

            function handleTogglePasswordVisibility() {
                const icon = togglePasswordButton.querySelector('i');
                if (!icon) return;
                const isPassword = passwordInput.type === 'password';
                passwordInput.type = isPassword ? 'text' : 'password';
                icon.classList.toggle('fa-eye', !isPassword);
                icon.classList.toggle('fa-eye-slash', isPassword);
                togglePasswordButton.title = isPassword ? "Hide Password" : "Show Password";
            }

            async function handleAddPassword(e) {
                e.preventDefault();
                const website = websiteInput.value.trim();
                const username = usernameInput.value.trim();
                const password = passwordInput.value; // Don't trim password

                if (!website || !username || !password) {
                    alert('Please fill in all fields.');
                    return;
                }

                const submitButton = passwordForm.querySelector('button[type="submit"]');
                const submitButtonText = submitButton.querySelector('.text');
                const originalButtonHTML = submitButtonText.innerHTML; // Store original content
                submitButton.disabled = true;
                submitButtonText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...'; // Loading state

                try {
                    const response = await fetch(`${API_BASE_URL}/passwords.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ website, username, password })
                    });

                    if (response.ok) {
                        passwordForm.reset(); // Clear the form
                        resetPasswordVisibilityToggle(); // Reset eye icon
                        fetchAndRenderPasswords(searchInput.value); // Refresh list (keeping search filter)
                    } else {
                         const data = await response.json().catch(() => ({}));
                         alert(`Error adding entry: ${data.error || response.statusText}`);
                         if (response.status === 401) { // Handle session expiry during action
                            showLoginScreenWithError("Session expired. Please log in again.");
                         }
                    }
                } catch (error) {
                    console.error('Error adding password:', error);
                    alert('Network error while adding entry.');
                } finally {
                    // Restore button state regardless of success/failure
                    submitButton.disabled = false;
                    submitButtonText.innerHTML = originalButtonHTML;
                }
            }

            let allPasswordsCache = []; // Cache fetched passwords
            function handleSearch(e) {
                renderPasswordsFromCache(e.target.value); // Filter based on input
            }

            // Event delegation for password list actions (copy, delete, reveal)
            function handleListActions(e) {
                const target = e.target;

                // Handle password reveal/hide
                const passwordValueSpan = target.closest('.password-value');
                if (passwordValueSpan) {
                    const listItem = passwordValueSpan.closest('li[data-id]');
                    if (!listItem) return;
                    const entryId = listItem.dataset.id;
                    const entry = allPasswordsCache.find(p => p.id == entryId); // Find from cache
                    if (entry) {
                        togglePasswordDisplay(passwordValueSpan, entry.password); // Pass actual password
                    }
                    return; // Stop further processing
                }

                // Handle button clicks (Copy/Delete)
                const actionButton = target.closest('.button-57');
                if (actionButton) {
                    const listItem = actionButton.closest('li[data-id]');
                    if (!listItem) return;
                    const entryId = listItem.dataset.id;
                    const entry = allPasswordsCache.find(p => p.id == entryId); // Find from cache
                    if (!entry) return;

                    if (actionButton.classList.contains('btn-copy')) {
                        copyPassword(actionButton, entry.password);
                    } else if (actionButton.classList.contains('btn-delete')) {
                        // Confirmation dialog
                        if (confirm(`Are you sure you want to delete the entry for "${entry.website}"? This cannot be undone.`)) {
                            deletePasswordEntry(entryId);
                        }
                    }
                }
            }

            async function handleExport() {
                 // Prevent multiple clicks
                 if (exportButton.disabled) return;

                 exportButton.disabled = true;
                 const exportButtonText = exportButton.querySelector('.text');
                 const originalExportHTML = exportButtonText.innerHTML;
                 exportButtonText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';

                try {
                    // Fetch fresh data for export to ensure it's current
                    const passwordsToExport = await fetchPasswords(true); // Pass flag to indicate it's for export

                    if (passwordsToExport.length === 0) {
                        alert("There are no entries to export.");
                        return; // Exit if nothing to export
                    }

                    // **Security Warning**
                    const proceed = confirm(
                        "⚠️ WARNING ⚠️\n\n" +
                        "You are about to export your stored entries.\n\n" +
                        "The downloaded file will contain your passwords in PLAIN TEXT and is NOT encrypted.\n\n" +
                        "Please store this file securely and delete it when no longer needed.\n\n" +
                        "Do you want to proceed?"
                    );

                    if (!proceed) {
                        return; // User cancelled
                    }

                    // Prepare and download JSON
                    const jsonData = JSON.stringify(passwordsToExport, null, 2); // Pretty print JSON
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const dateString = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                    a.download = `password_vault_export_${dateString}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url); // Clean up blob URL

                } catch (error) {
                     console.error("Error during export:", error);
                     alert(`An error occurred while trying to fetch data for export: ${error.message || 'Unknown error'}`);
                     // Handle session expiry specifically if that was the error
                     if (error.message && error.message.includes("Session expired")) {
                         showLoginScreenWithError("Session expired. Please log in again to export.");
                     }
                } finally {
                     // Restore button state
                     exportButtonText.innerHTML = originalExportHTML;
                     // Re-enable only if there's data in the cache (might be slightly out of sync if fetch failed, but better UX)
                     exportButton.disabled = allPasswordsCache.length === 0;
                }
            }

            // --- Data Fetching and Rendering ---

            // Modified fetchPasswords to handle potential errors and session expiry
            async function fetchPasswords(isExport = false) {
                if (!isExport) { // Don't show loading state if it's a background fetch for export
                    passwordList.innerHTML = `<li class="no-entries">Loading entries...</li>`;
                    exportButton.disabled = true; // Disable export while loading
                }
                try {
                    const response = await fetch(`${API_BASE_URL}/passwords.php`, { credentials: 'include' });

                    if (response.ok) {
                        const data = await response.json();
                        return data; // Return the fetched data
                    } else {
                         if (response.status === 401) {
                             // Throw specific error for session expiry
                             throw new Error("Session expired. Please log in again.");
                         }
                         // Handle other errors
                         const errorData = await response.json().catch(() => ({}));
                         console.error("Error fetching passwords:", response.status, errorData.error);
                         if (!isExport) {
                            passwordList.innerHTML = `<li class="no-entries">Error fetching entries: ${escapeHtml(errorData.error || response.statusText)}</li>`;
                         }
                         return []; // Return empty array on error
                    }
                } catch (error) {
                    // Rethrow session expiry error to be caught by caller
                    if (error.message && error.message.includes("Session expired")) {
                        throw error;
                    }
                    // Handle network errors
                    console.error('Network error fetching passwords:', error);
                     if (!isExport) {
                        passwordList.innerHTML = `<li class="no-entries">Network error fetching entries.</li>`;
                     }
                    return []; // Return empty array on network error
                }
            }

            // Fetches passwords and updates the cache, then renders
            async function fetchAndRenderPasswords(filter = '') {
                try {
                    allPasswordsCache = await fetchPasswords(); // Fetch and update cache
                    renderPasswordsFromCache(filter); // Render using the new cache
                } catch (error) {
                     // Handle session expiry specifically
                     if (error.message && error.message.includes("Session expired")) {
                         showLoginScreenWithError(error.message);
                         // Update UI to reflect logged-out state
                         passwordList.innerHTML = `<li class="no-entries">Session expired. Please log in.</li>`;
                         exportButton.disabled = true;
                         allPasswordsCache = []; // Clear cache
                     } else {
                         // For other errors, the fetchPasswords function already updated the list message
                         exportButton.disabled = true; // Ensure export is disabled on error
                     }
                }
            }

            // Renders the list from the existing cache, applying filter
            function renderPasswordsFromCache(filter = '') {
                const lowerCaseFilter = filter.toLowerCase().trim();
                const filteredPasswords = allPasswordsCache.filter(p =>
                    (p.website && p.website.toLowerCase().includes(lowerCaseFilter)) ||
                    (p.username && p.username.toLowerCase().includes(lowerCaseFilter))
                );

                exportButton.disabled = allPasswordsCache.length === 0; // Enable/disable export based on *total* entries
                passwordList.innerHTML = ''; // Clear current list

                if (allPasswordsCache.length === 0) {
                    // Check if the list already shows an error/network message before overwriting
                     const currentMessage = passwordList.querySelector('.no-entries')?.textContent || '';
                     if (!currentMessage.toLowerCase().includes("error") && !currentMessage.toLowerCase().includes("network")) {
                         passwordList.innerHTML = `<li class="no-entries">Your vault is empty. Add an entry!</li>`;
                     }
                } else if (filteredPasswords.length === 0) {
                    passwordList.innerHTML = `<li class="no-entries">No entries match your search "${escapeHtml(filter)}".</li>`;
                } else {
                    // Sort alphabetically by website name
                    filteredPasswords.sort((a, b) => (a.website || '').localeCompare(b.website || ''));
                    // Create and append list items
                    filteredPasswords.forEach(entry => {
                        const listItem = document.createElement('li');
                        listItem.dataset.id = entry.id; // Store ID for actions
                        // Use escaped data for HTML generation
                        listItem.innerHTML = createPasswordListItemHTML({
                             ...entry,
                             website: escapeHtml(entry.website),
                             username: escapeHtml(entry.username)
                             // Password is not escaped here, handled by togglePasswordDisplay
                        });
                        passwordList.appendChild(listItem);
                    });
                }
            }

            // Generates HTML for a single password list item
            function createPasswordListItemHTML(entry) {
                const escapedWebsite = entry.website || 'N/A';
                const escapedUsername = entry.username || 'N/A';
                // Note: entry.password is the raw password, used only in JS logic
                return `
                    <div class="password-entry-details">
                        <strong>${escapedWebsite}</strong>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-user"></i> User:</span>
                            <span class="username-value">${escapedUsername}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-key"></i> Pass:</span>
                            <span class="password-value-container">
                                <span class="password-value" title="Click to reveal / hide password">${MASKED_PASSWORD_CHAR}</span>
                            </span>
                        </div>
                    </div>
                    <div class="password-entry-actions">
                        <button class="button-57 button-57-secondary btn-copy" role="button" title="Copy Password to Clipboard">
                            <span class="text"><i class="fas fa-copy"></i> Copy</span>
                            <span>Copy Pass</span>
                        </button>
                        <button class="button-57 button-57-danger btn-delete" role="button" title="Delete this Entry">
                            <span class="text"><i class="fas fa-trash-alt"></i> Delete</span>
                            <span>Remove</span>
                        </button>
                    </div>
                `;
            }

            // Toggles display between masked characters and actual password
            function togglePasswordDisplay(element, actualPassword) {
                if (element.textContent === MASKED_PASSWORD_CHAR) {
                    element.textContent = escapeHtml(actualPassword); // Escape just before displaying
                    element.classList.add('visible');
                } else {
                    element.textContent = MASKED_PASSWORD_CHAR;
                    element.classList.remove('visible');
                }
            }

            // Copies password and provides visual feedback
            async function copyPassword(buttonElement, password) {
                 const textSpan = buttonElement.querySelector('.text');
                 // Prevent copying if already copied or disabled
                 if (!textSpan || buttonElement.disabled || buttonElement.classList.contains('copied')) return;

                 const originalTextHTML = textSpan.innerHTML;
                 buttonElement.disabled = true; // Disable during copy and feedback
                 buttonElement.classList.add('copied'); // Add 'copied' class for styling
                 textSpan.innerHTML = '<i class="fas fa-check"></i> Copied!'; // Feedback text

                 try {
                     await navigator.clipboard.writeText(password);
                     // Revert button state after a delay
                     setTimeout(() => {
                         // Check if the button still exists and is in the copied state
                         const currentButton = document.querySelector(`li[data-id="${buttonElement.closest('li[data-id]').dataset.id}"] .btn-copy.copied`);
                         if (currentButton) {
                              const currentTextSpan = currentButton.querySelector('.text');
                              currentTextSpan.innerHTML = originalTextHTML;
                              currentButton.classList.remove('copied');
                              currentButton.disabled = false; // Re-enable
                         }
                     }, 1800); // Duration of "Copied!" message
                 } catch (err) {
                     console.error('Failed to copy password: ', err);
                     alert('Failed to copy password.');
                      // Revert immediately on error
                      textSpan.innerHTML = originalTextHTML;
                      buttonElement.classList.remove('copied');
                      buttonElement.disabled = false;
                 }
            }

            // Deletes an entry via API call and updates UI
            async function deletePasswordEntry(id) {
                const listItem = passwordList.querySelector(`li[data-id="${id}"]`);
                // Optimistic UI update: fade out before confirming deletion
                if (listItem) {
                    listItem.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                    listItem.style.opacity = '0';
                    listItem.style.transform = 'translateX(-20px)';
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/passwords.php?id=${id}`, {
                        method: 'DELETE',
                        headers: { 'Accept': 'application/json' },
                        credentials: 'include'
                    });

                    if (response.ok) {
                        // Remove from cache and re-render after successful deletion
                        allPasswordsCache = allPasswordsCache.filter(entry => entry.id != id);
                        // Delay rendering slightly to allow fade-out animation
                        setTimeout(() => {
                            renderPasswordsFromCache(searchInput.value);
                        }, 300);
                    } else {
                         // Revert optimistic UI update if deletion failed
                         if (listItem) {
                            listItem.style.opacity = '1';
                            listItem.style.transform = 'translateX(0)';
                         }
                         const data = await response.json().catch(() => ({}));
                         alert(`Error deleting entry: ${data.error || response.statusText}`);
                          if (response.status === 401) { // Handle session expiry
                            showLoginScreenWithError("Session expired. Please log in again.");
                          }
                    }
                } catch (error) {
                    // Revert optimistic UI update on network error
                    if (listItem) {
                       listItem.style.opacity = '1';
                       listItem.style.transform = 'translateX(0)';
                    }
                    console.error('Error deleting password:', error);
                    alert('Network error while deleting entry.');
                }
            }

            // --- Utility Functions ---

            // Resets the password visibility toggle icon/state
            function resetPasswordVisibilityToggle() {
                passwordInput.type = 'password';
                const icon = togglePasswordButton.querySelector('i');
                 if (icon) {
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                    togglePasswordButton.title = "Show Password";
                 }
            }

            // Basic HTML escaping function
            function escapeHtml(unsafe) {
                if (typeof unsafe !== 'string') { return unsafe; }
                return unsafe
                         .replace(/&/g, "&")
                         .replace(/</g, "<")
                         .replace(/>/g, ">")
                         .replace(/"/g, """)
                         .replace(/'/g, "'");
             }

        });
        // --- End Embedded JavaScript ---
    </script>

</body>
</html>
