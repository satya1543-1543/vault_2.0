<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Favicon Link -->
    <link rel="icon" type="image/png" href="https://i.ibb.co/7JfMHZQj/vault.png">

    <!-- PWA Manifest Link (Ensure manifest.json exists at the root) -->
    <link rel="manifest" href="/manifest.json">

    <!-- PWA Theme color -->
    <meta name="theme-color" content="#5480ca">

    <!-- Add to home screen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Local Vault">
    <!-- Optional: Add Apple touch icons if needed -->
    <!-- <link rel="apple-touch-icon" href="icons/apple-touch-icon.png"> -->

    <title>Vault</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        /* --- Start Embedded CSS --- */

        /* --- Variables & Base --- */
        :root {
            --primary-color: #5480ca; /* Slightly softer blue */
            --secondary-color: #50e3c2; /* Teal */
            --tertiary-color: #f39c12; /* Orange for export */
            --background-start: #eef4f8; /* Light blueish grey */
            --background-end: #f8f0fc;   /* Light purplish grey */
            --card-background: #ffffff;
            --card-background-soft: #fcfdff; /* Slightly off-white for sections */
            --text-color: #34495e; /* Darker blue-grey */
            --text-muted: #7f8c8d; /* Grey */
            --border-color: #e0e6ed; /* Lighter grey border */
            --danger-color: #e74c3c; /* Softer red */
            --success-color: #2ecc71; /* Softer green */
            --font-family: 'Poppins', sans-serif;
            --border-radius: 12px; /* Slightly more rounded */
            --base-shadow: 0 5px 18px rgba(0, 0, 0, 0.07);
            --hover-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --input-background: #f8f9fa;

            /* Button 57 Specific Colors */
            --btn57-dark: #18181a;
            --btn57-light: #ffffff;

            /* Toast Colors */
            --toast-success-bg: #e9f7ef;
            --toast-success-border: #a1e0b9;
            --toast-success-text: #1e462e;
            --toast-error-bg: #fdeded;
            --toast-error-border: #f7c5c5;
            --toast-error-text: #5a1d1d;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            color: var(--text-color);
            line-height: 1.7;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--background-start), var(--background-end));
            background-size: 400% 400%;
            animation: gradientBG 25s ease infinite;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Login Screen Styles --- */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(238, 244, 248, 0.95); /* Slightly less transparent */
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
            opacity: 0;
            visibility: hidden; /* Use visibility for better accessibility */
        }

        #login-screen.visible {
             opacity: 1;
             visibility: visible;
        }

        .login-container {
            background-color: var(--card-background);
            padding: 2.5rem 3rem;
            border-radius: var(--border-radius);
            box-shadow: var(--hover-shadow);
            text-align: center;
            max-width: 420px; /* Slightly wider */
            width: 100%;
            border: 1px solid var(--border-color);
            position: relative; /* For potential absolute elements inside */
        }

        .login-icon {
            font-size: 3.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
            display: block; /* Center it */
            line-height: 1;
        }

        .login-container h2 {
            color: var(--primary-color);
            margin-bottom: 0.8rem;
            font-size: 1.8rem;
            font-weight: 700; /* Bolder */
        }
        .login-container h2 i {
            margin-right: 0.6rem;
            vertical-align: baseline;
        }

        .login-container p {
            color: var(--text-muted);
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        #pin-entry-section, #pin-setup-section {
             margin-bottom: 1.5rem;
        }

        /* New PIN Input Group */
        .pin-input-group {
            display: flex;
            justify-content: center;
            gap: 10px; /* Gap between digits */
            margin-bottom: 1.5rem;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--input-background);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .pin-input-group.focused {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(84, 128, 202, 0.2);
        }

        .pin-digit {
            width: 50px; /* Slightly smaller */
            height: 60px;
            font-size: 2rem;
            text-align: center;
            border: none; /* Remove individual borders */
            border-radius: 8px; /* Smaller radius for digits */
            background-color: #fff; /* White background for digits */
            color: var(--text-color);
            caret-color: var(--primary-color);
            font-weight: 600;
            line-height: 60px; /* Center text vertically */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            /* Remove spinners for number input */
            -moz-appearance: textfield;
            appearance: textfield;
        }
        .pin-digit::-webkit-outer-spin-button,
        .pin-digit::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        .pin-digit:focus {
            outline: none;
            /* Focus handled by the parent group */
        }

        #pin-error-message {
            color: var(--danger-color);
            background-color: var(--toast-error-bg);
            border: 1px solid var(--toast-error-border);
            border-radius: 8px;
            padding: 0.8rem 1rem;
            min-height: 1.2em;
            margin-top: -1rem;
            margin-bottom: 1rem;
            font-weight: 600;
            font-size: 0.9rem;
            text-align: center;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.3s ease-in-out;
            display: none; /* Use display none/block with opacity */
        }
        #pin-error-message.show {
            display: block;
            opacity: 1;
        }

        /* Shake animation for incorrect PIN */
        @keyframes shake {
          10%, 90% { transform: translateX(-1px); }
          20%, 80% { transform: translateX(2px); }
          30%, 50%, 70% { transform: translateX(-4px); }
          40%, 60% { transform: translateX(4px); }
        }
        .shake {
          animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* Setup Form Styles (Kept for visual consistency or instructions) */
        #pin-setup-section .form-group { margin-bottom: 1rem; text-align: left; }
        #pin-setup-section label { display: block; margin-bottom: 0.4rem; font-weight: 600; color: var(--text-muted); font-size: 0.85rem; }
        #pin-setup-section input[type="password"] { width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 1rem; }
        #pin-setup-section input[type="password"]:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(84, 128, 202, 0.2); }
        #setup-pin-button { margin-top: 1rem; width: 100%; }
        #setup-error-message { color: var(--danger-color); min-height: 1.2em; margin-top: 0.5rem; font-weight: 600; font-size: 0.9rem; }


        /* --- Vault Container (Initially Hidden) --- */
        #vault-container {
            display: none; /* Hide vault initially */
            width: 100%;
            max-width: 900px; /* Slightly wider */
            margin: 3rem auto;
            padding: 2rem 2.5rem;
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--base-shadow);
            flex-grow: 1;
            transition: box-shadow 0.3s ease;
            border: 1px solid var(--border-color);
        }
        #vault-container:hover {
             box-shadow: var(--hover-shadow);
        }

        /* --- Header --- */
        header {
            text-align: center;
            margin-bottom: 3rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        header h1 {
            color: var(--primary-color);
            margin-bottom: 0;
            font-weight: 700; /* Bolder */
            font-size: 2.4rem; /* Slightly larger */
            word-break: break-word;
        }

        header h1 .icon {
            margin-right: 0.8rem;
            vertical-align: middle;
            font-size: 2.2rem; /* Adjust icon size */
        }

        /* --- Sections & Headings --- */
        .add-password-form,
        .password-list-section {
            margin-bottom: 2.5rem;
            padding: 2rem;
            background-color: var(--card-background-soft);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            /* border-top: 3px solid var(--primary-color); Subtle top border */
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        /* Shared h2 styles */
        h2 {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 1.6rem;
            display: inline-flex; /* Use flex for icon alignment */
            align-items: center;
            margin-right: 1rem;
            flex-shrink: 0;
        }
         h2 i {
             margin-right: 0.7rem;
             font-size: 1.4rem; /* Adjust icon size */
             vertical-align: middle; /* Better alignment */
             color: var(--secondary-color); /* Use secondary color for icons */
         }

        /* Vault specific h2 styles */
        #vault-container h2 {
             border-bottom: 3px solid var(--secondary-color);
             padding-bottom: 0.6rem;
        }
        /* Login specific h2 styles (already handled in .login-container h2) */


        /* --- Forms --- */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.6rem;
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .form-group label i {
            margin-right: 0.4rem;
            width: 1em; /* Ensure consistent spacing */
        }

        .form-group input[type="text"],
        .form-group input[type="password"],
        .search-container input[type="text"] {
            width: 100%;
            padding: 0.9rem 1.1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-family: inherit;
            color: var(--text-color);
            background-color: #fff; /* Ensure white background */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-group input::placeholder,
        .search-container input::placeholder {
            color: #bbb;
        }

        .form-group input:focus,
        .search-container input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(84, 128, 202, 0.2);
        }

        .password-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-input-wrapper input {
            padding-right: 3.5rem; /* Space for the button */
        }

        .toggle-visibility {
            position: absolute;
            right: 1px;
            top: 1px;
            bottom: 1px;
            width: 3.2rem;
            background: transparent;
            border: none;
            border-left: 1px solid var(--border-color);
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1.1rem;
            transition: color 0.3s ease, background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-visibility:hover {
            color: var(--primary-color);
            background-color: #f0f5fa;
        }
        .toggle-visibility:active {
            background-color: #e1eaf3;
        }

        .toggle-visibility i {
            pointer-events: none;
        }

        /* --- Button 57 Styles (Keep as is, but add active state) --- */
        .button-57 {
          position: relative;
          overflow: hidden;
          border: 1px solid var(--btn57-dark);
          color: var(--btn57-dark);
          display: inline-block;
          font-size: 15px;
          line-height: 15px;
          padding: 16px 18px 15px;
          text-decoration: none;
          cursor: pointer;
          background: var(--btn57-light);
          user-select: none;
          -webkit-user-select: none;
          touch-action: manipulation;
          border-radius: var(--border-radius);
          font-family: inherit;
          font-weight: 600;
          margin: 5px;
          vertical-align: middle;
          text-align: center;
          transition: all 0.3s ease, transform 0.1s ease; /* Add transform transition */
        }
        .button-57:active:not(:disabled) {
            transform: scale(0.98); /* Click feedback */
        }

        .button-57 .text,
        .button-57 span:first-child {
          position: relative;
          transition: color 600ms cubic-bezier(0.48, 0, 0.12, 1);
          z-index: 10;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          width: 100%;
        }
        .button-57 .text i,
        .button-57 span:first-child i {
            margin-right: 0.6rem;
        }

        .button-57 span:last-child {
          color: var(--btn57-light);
          display: block;
          position: absolute;
          bottom: 0;
          transition: all 500ms cubic-bezier(0.48, 0, 0.12, 1);
          z-index: 100;
          opacity: 0;
          top: 50%;
          left: 50%;
          transform: translateY(225%) translateX(-50%);
          height: 14px;
          line-height: 13px;
          white-space: nowrap;
        }

        .button-57:after {
          content: "";
          position: absolute;
          bottom: -50%;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: var(--btn57-dark);
          transform-origin: bottom center;
          transition: transform 600ms cubic-bezier(0.48, 0, 0.12, 1);
          transform: skewY(9.3deg) scaleY(0);
          z-index: 50;
          border-radius: inherit;
        }

        .button-57:hover:not(:disabled):after {
          transform-origin: bottom center;
          transform: skewY(9.3deg) scaleY(2);
        }

        .button-57:hover:not(:disabled) span:last-child {
          transform: translateX(-50%) translateY(-100%);
          opacity: 1;
          transition: all 900ms cubic-bezier(0.48, 0, 0.12, 1);
        }

        .button-57:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .button-57:disabled:after {
             transform: skewY(9.3deg) scaleY(0);
        }
        .button-57:disabled span:last-child {
            opacity: 0;
        }

        /* --- Button 57 Color Variations (Keep as is) --- */
        .button-57-primary { border-color: var(--primary-color); color: var(--primary-color); }
        .button-57-primary:after { background-color: var(--primary-color); }
        .button-57-primary:hover:not(:disabled) .text,
        .button-57-primary:hover:not(:disabled) span:first-child { color: var(--btn57-light); }

        .button-57-secondary { border-color: var(--secondary-color); color: var(--secondary-color); padding: 10px 12px 9px; font-size: 14px; }
        .button-57-secondary:after { background-color: var(--secondary-color); }
        .button-57-secondary:hover:not(:disabled) .text,
        .button-57-secondary:hover:not(:disabled) span:first-child { color: var(--btn57-dark); }
        .button-57-secondary span:last-child { color: var(--btn57-dark); }

        .button-57-secondary.copied { border-color: var(--success-color); color: var(--success-color); }
        .button-57-secondary.copied:after { background-color: var(--success-color); transform: skewY(9.3deg) scaleY(2); }
        .button-57-secondary.copied .text,
        .button-57-secondary.copied span:first-child { color: var(--btn57-light); }
        .button-57-secondary.copied span:last-child { opacity: 0; }
        .button-57-secondary.copied:disabled:after { background-color: var(--success-color); transform: skewY(9.3deg) scaleY(2); }
        .button-57-secondary.copied:disabled .text { color: var(--btn57-light); }

        .button-57-danger { border-color: var(--danger-color); color: var(--danger-color); padding: 10px 12px 9px; font-size: 14px; }
        .button-57-danger:after { background-color: var(--danger-color); }
        .button-57-danger:hover:not(:disabled) .text,
        .button-57-danger:hover:not(:disabled) span:first-child { color: var(--btn57-light); }

        .button-57-export { border-color: var(--tertiary-color); color: var(--tertiary-color); }
        .button-57-export:after { background-color: var(--tertiary-color); }
        .button-57-export:hover:not(:disabled) .text,
        .button-57-export:hover:not(:disabled) span:first-child { color: var(--btn57-light); }

        /* --- Password List --- */
        .search-container {
            position: relative;
            margin-bottom: 2rem;
        }

        .search-container input {
            padding-left: 3rem; /* Space for icon */
            padding-right: 2.5rem; /* Space for clear button */
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1.1rem;
            pointer-events: none;
        }
        /* Search Clear Button */
        #search-clear-button {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.3rem;
            line-height: 1;
            display: none; /* Hidden by default */
        }
        #search-clear-button:hover {
            color: var(--danger-color);
        }

        .password-list-container {
            position: relative; /* For loading indicator */
            min-height: 100px; /* Ensure space for loader */
        }

        #loading-indicator {
            position: absolute;
            top: 40px; /* Adjust as needed */
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
            color: var(--primary-color);
            display: none; /* Hidden by default */
            z-index: 5;
        }
        #loading-indicator.show {
            display: block;
        }
        #loading-indicator i {
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        .password-list {
            list-style: none;
            padding: 0;
        }

        .password-list li {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 1.2rem;
            padding: 1.5rem 2rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            box-shadow: var(--base-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
        }

        .password-list li:hover {
             transform: translateY(-4px) scale(1.01);
             box-shadow: var(--hover-shadow);
             background-color: var(--background-start); /* Subtle background change */
        }

        .password-list li.no-entries {
            text-align: center;
            color: var(--text-muted);
            padding: 3rem 2rem; /* More padding */
            font-style: italic;
            font-size: 1.1rem; /* Slightly larger */
            justify-content: center;
            border: 2px dashed var(--border-color);
            background-color: var(--card-background-soft);
            box-shadow: none;
            transform: none;
            flex-direction: column;
            font-weight: 500;
        }
        .password-list li.no-entries:hover {
             transform: none;
             box-shadow: none;
             background-color: var(--card-background-soft); /* No hover bg change */
        }


        .password-entry-details {
            flex-grow: 1;
            min-width: 200px;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
        }

        .password-entry-details strong {
            color: var(--primary-color);
            display: block;
            font-size: 1.3rem; /* Slightly larger */
            font-weight: 600;
            margin-bottom: 0.7rem; /* More space */
        }

        .password-entry-details .detail-item {
            margin-bottom: 0.5rem; /* More space */
            font-size: 1rem;
            color: var(--text-color);
            display: flex;
            align-items: center; /* Center align icon/label with value */
            gap: 0.7rem;
        }

        .detail-item .label {
            font-weight: 600;
            color: var(--text-muted);
            min-width: 60px; /* Slightly wider */
            font-size: 0.9rem;
            flex-shrink: 0;
            display: inline-flex; /* Align icon */
            align-items: center;
        }
        .detail-item .label i {
            margin-right: 0.5rem;
            width: 1em; /* Consistent icon width */
            text-align: center;
            color: var(--secondary-color); /* Icon color */
        }

        .detail-item .username-value,
        .detail-item .password-value-container {
            flex-grow: 1;
            min-width: 0;
        }

        .password-value {
            font-family: 'Courier New', Courier, monospace;
            cursor: pointer;
            display: inline-block;
            background-color: #e8eef3; /* Slightly different bg */
            padding: 0.3rem 0.7rem; /* Adjust padding */
            border-radius: 6px;
            user-select: none;
            transition: background-color 0.3s ease, color 0.3s ease;
            line-height: 1.4;
            word-break: break-all;
            font-size: 0.95rem; /* Slightly smaller monospace */
        }

        .password-value:hover {
            background-color: #dfe6e9;
        }

        .password-value.visible {
            background-color: transparent;
            padding: 0.3rem 0;
            user-select: text;
            color: var(--success-color);
            font-weight: 600;
            font-family: var(--font-family); /* Use normal font when visible */
            font-size: 1rem; /* Match normal text size */
        }

        .password-entry-actions {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex-shrink: 0;
            gap: 0.6rem; /* Slightly more gap */
        }

        /* --- Footer --- */
        footer {
            text-align: center;
            margin-top: 3rem;
            padding: 1.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
            background-color: rgba(255, 255, 255, 0.7);
            border-top: 1px solid var(--border-color);
        }
        footer p {
            font-weight: 500;
        }

        /* --- Toast Notifications --- */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background-color: #fff;
            border-left: 5px solid var(--primary-color);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 1rem 1.5rem;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 250px;
            max-width: 350px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            background-color: var(--toast-success-bg);
            border-left-color: var(--success-color);
            color: var(--toast-success-text);
        }
        .toast.success .toast-icon { color: var(--success-color); }

        .toast.error { /* Example error style if needed */
            background-color: var(--toast-error-bg);
            border-left-color: var(--danger-color);
            color: var(--toast-error-text);
        }
        .toast.error .toast-icon { color: var(--danger-color); }

        .toast-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        .toast-message {
            font-size: 0.95rem;
            font-weight: 500;
            flex-grow: 1;
        }


        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            #vault-container { margin: 1.5rem 1rem; padding: 1.5rem; }
            .login-container { padding: 2rem 1.5rem; max-width: 380px; }
            .pin-digit { width: 45px; height: 55px; font-size: 1.8rem; line-height: 55px; }
            .pin-input-group { gap: 8px; padding: 8px; }

            header h1 { font-size: 2rem; }
            header h1 .icon { font-size: 1.8rem; }
            .section-header { margin-bottom: 1.5rem; gap: 1rem; }
            h2 { font-size: 1.4rem; }
            h2 i { font-size: 1.2rem; }
            #vault-container h2 { padding-bottom: 0.5rem; }

            .section-header .button-57-export { width: 100%; margin: 0; }
            #password-form .button-57-primary { width: 100%; margin-left: 0; margin-right: 0; }

            .password-list li { flex-direction: column; align-items: stretch; padding: 1.2rem 1.5rem; gap: 1.2rem; }
            .password-list li:hover { transform: translateY(-2px); scale: 1; }
            .password-entry-details { width: 100%; min-width: auto; }
            .password-entry-actions { width: 100%; justify-content: flex-end; }
            .button-57-secondary, .button-57-danger { padding: 9px 11px 8px; font-size: 13px; }
        }

        @media (max-width: 480px) {
            html { font-size: 15px; }
            #vault-container { margin: 1rem 0.5rem; padding: 1rem; border-radius: 10px; }
            .login-container { padding: 1.5rem 1rem; max-width: 95%; }
            .pin-digit { width: 40px; height: 50px; font-size: 1.6rem; line-height: 50px; border-radius: 6px;}
            .pin-input-group { gap: 6px; padding: 6px; }
            .login-icon { font-size: 3rem; }

            .add-password-form, .password-list-section { padding: 1.2rem; }
            header { margin-bottom: 2rem; padding-bottom: 1rem; }
            header h1 { font-size: 1.8rem; }
            header h1 .icon { font-size: 1.6rem; }

            .section-header { margin-bottom: 1.5rem; gap: 0.8rem; }
            h2 { font-size: 1.3rem; padding-bottom: 0.5rem; }
            h2 i { font-size: 1.1rem; }
            #vault-container h2 { padding-bottom: 0.4rem; }

            .button-57 { font-size: 14px; padding: 14px 16px 13px; margin: 3px; }
            .button-57-secondary, .button-57-danger { font-size: 13px; padding: 9px 10px 8px; }
            .button-57-export, #password-form .button-57-primary, #setup-pin-button { font-size: 14px; padding: 14px 16px 13px; }

            .password-entry-details strong { font-size: 1.15rem; }
            .password-entry-details .detail-item { font-size: 0.95rem; gap: 0.5rem; }
            .detail-item .label { min-width: 55px; font-size: 0.85rem; }
            .detail-item .label i { margin-right: 0.4rem; }

            .password-list li { padding: 1rem 1.2rem; gap: 1rem; }
            .password-list li.no-entries { padding: 2rem 1rem; font-size: 1rem; }

            .search-container input { padding-left: 2.5rem; padding-right: 2.2rem; }
            .search-icon { left: 0.8rem; font-size: 1rem; }
            #search-clear-button { right: 0.3rem; font-size: 1.1rem; }

            #toast-container { bottom: 10px; right: 10px; width: calc(100% - 20px); }
            .toast { min-width: unset; max-width: unset; width: 100%; }
        }
        /* --- End Embedded CSS --- */
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-container">
            <!-- PIN Setup Section (Hidden by default, informational only) -->
            <div id="pin-setup-section" style="display: none;">
                 <h2><i class="fas fa-user-shield"></i> Set Up Your PIN</h2>
                 <p>PIN setup must be done via the server-side `setup_pin.php` script. Contact the administrator if a PIN needs to be set or reset.</p>
                 {/* ... setup form elements (disabled) ... */}
            </div>

            <!-- PIN Entry Section -->
            <div id="pin-entry-section"> <!-- Shown/hidden by JS controlling parent #login-screen -->
                <i class="fas fa-shield-virus login-icon"></i> <!-- Changed Icon -->
                <h2><i class="fas fa-lock"></i> Enter PIN</h2>
                <p>Enter the 4-digit PIN to unlock the vault.</p>
                <!-- Updated PIN Input Structure -->
                <div class="pin-input-group" id="pin-container">
                    <input type="password" class="pin-digit" id="pin-1" maxlength="1" inputmode="numeric" pattern="[0-9]*" required autocomplete="one-time-code" aria-label="PIN Digit 1">
                    <input type="password" class="pin-digit" id="pin-2" maxlength="1" inputmode="numeric" pattern="[0-9]*" required autocomplete="one-time-code" aria-label="PIN Digit 2">
                    <input type="password" class="pin-digit" id="pin-3" maxlength="1" inputmode="numeric" pattern="[0-9]*" required autocomplete="one-time-code" aria-label="PIN Digit 3">
                    <input type="password" class="pin-digit" id="pin-4" maxlength="1" inputmode="numeric" pattern="[0-9]*" required autocomplete="one-time-code" aria-label="PIN Digit 4">
                </div>
                <div id="pin-error-message" aria-live="polite"></div> <!-- Styled error message box -->
            </div>
        </div>
    </div>

    <!-- Main Vault Content (Initially Hidden) -->
    <div id="vault-container" class="container">
        <header>
            <h1><i class="fas fa-shield-alt icon"></i> Secure Vault</h1> <!-- Added "Secure" -->
        </header>

        <section class="add-password-form">
            <h2><i class="fas fa-plus-circle"></i> Add New Entry</h2>
            <form id="password-form">
                <div class="form-group">
                    <label for="website-name"><i class="fas fa-globe"></i> Website / Service Name</label>
                    <input type="text" id="website-name" required placeholder="e.g., My Favorite Website">
                </div>
                <div class="form-group">
                    <label for="username"><i class="fas fa-user"></i> Username / Email</label>
                    <input type="text" id="username" required placeholder="e.g., user@email.com">
                </div>
                <div class="form-group">
                    <label for="password"><i class="fas fa-key"></i> Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="password" required placeholder="Enter your password">
                        <button type="button" class="toggle-visibility" title="Show / Hide Password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" class="button-57 button-57-primary" role="button">
                    <span class="text"><i class="fas fa-save"></i> Save Entry</span>
                    <span>Confirm Save</span>
                </button>
            </form>
        </section>

        <section class="password-list-section">
            <div class="section-header">
                <h2><i class="fas fa-list-ul"></i> Stored Entries</h2>
                <button id="export-button" class="button-57 button-57-export" role="button" title="Export all entries to a JSON file" disabled>
                    <span class="text"><i class="fas fa-download"></i> Export All</span>
                    <span>Download File</span>
                </button>
            </div>
             <div class="search-container">
                 <i class="fas fa-search search-icon"></i>
                 <input type="text" id="search-input" placeholder="Search by website or username...">
                 <button id="search-clear-button" title="Clear Search" aria-label="Clear Search"><i class="fas fa-times-circle"></i></button>
            </div>
            <div class="password-list-container">
                <div id="loading-indicator" aria-label="Loading entries">
                    <i class="fas fa-spinner"></i> Loading...
                </div>
                <ul id="password-list" class="password-list">
                    <!-- Password entries dynamically loaded here -->
                     <li class="no-entries">Initializing vault...</li> <!-- Initial message -->
                </ul>
            </div>
        </section>
    </div>

    <footer>
        <p>© 2025 Enhanced Vault Demo — Powered by Danav</p> <!-- Updated footer text -->
    </footer>

    <!-- Toast Notification Container -->
    <div id="toast-container" aria-live="polite"></div>

    <script>
        // --- Start Embedded JavaScript ---
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js') // Use absolute path
              .then(registration => console.log('SW registered:', registration.scope))
              .catch(error => console.error('SW registration failed:', error));
          });
        }

        document.addEventListener('DOMContentLoaded', () => {

            // --- Constants ---
            const MASKED_PASSWORD_CHAR = '••••••••';
            const API_BASE_URL = '/api'; // Adjust if needed

            // --- DOM Elements ---
            const loginScreen = document.getElementById('login-screen');
            const pinEntrySection = document.getElementById('pin-entry-section');
            const pinContainer = document.getElementById('pin-container');
            const pinInputGroup = document.getElementById('pin-container'); // The group div
            const pinInputs = Array.from(pinContainer.querySelectorAll('.pin-digit'));
            const pinErrorMessage = document.getElementById('pin-error-message');
            const vaultContainer = document.getElementById('vault-container');
            const passwordForm = document.getElementById('password-form');
            const websiteInput = document.getElementById('website-name');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const passwordList = document.getElementById('password-list');
            const togglePasswordButton = document.querySelector('.toggle-visibility');
            const searchInput = document.getElementById('search-input');
            const searchClearButton = document.getElementById('search-clear-button');
            const exportButton = document.getElementById('export-button');
            const loadingIndicator = document.getElementById('loading-indicator');
            const toastContainer = document.getElementById('toast-container');

            let allPasswordsCache = []; // Cache for client-side filtering
            let vaultInitialized = false; // Flag to prevent multiple initializations

            // --- Initialization ---
            checkAuthenticationStatus();

            // --- Login Logic ---

            async function checkAuthenticationStatus() {
                showLoadingIndicator(true); // Show loading initially
                try {
                    const response = await fetch(`${API_BASE_URL}/passwords.php`, { credentials: 'include' });
                    if (response.ok) {
                        hideLoginScreen();
                        await initializeVault(); // Wait for vault init before hiding loader
                    } else if (response.status === 401) {
                        showLoginScreen();
                    } else {
                        console.error("Error checking auth status:", response.status, await response.text());
                        showLoginScreenWithError(`Server error (${response.status}) checking login status.`);
                    }
                } catch (error) {
                    console.error("Network error checking auth status:", error);
                    showLoginScreenWithError("Network error. Cannot reach server.");
                } finally {
                    // Hide general loading only if login screen isn't shown
                    if (!loginScreen.classList.contains('visible')) {
                        showLoadingIndicator(false);
                    }
                }
            }

            function showLoginScreen() {
                clearPinError();
                pinInputs.forEach(input => input.value = '');
                loginScreen.classList.add('visible');
                vaultContainer.style.display = 'none';
                setupPinInputListeners(); // Setup listeners every time it's shown
                setTimeout(() => pinInputs[0]?.focus(), 100); // Delay focus slightly
                showLoadingIndicator(false); // Hide vault loader if login shows
            }

            function showLoginScreenWithError(message) {
                showLoginScreen();
                displayPinError(message);
            }

            function hideLoginScreen() {
                 loginScreen.classList.remove('visible');
                 vaultContainer.style.display = 'block'; // Show vault container
            }

            function displayPinError(message) {
                pinErrorMessage.textContent = message;
                pinErrorMessage.classList.add('show');
            }

            function clearPinError() {
                pinErrorMessage.textContent = '';
                pinErrorMessage.classList.remove('show');
            }

            function setupPinInputListeners() {
                // Use event delegation on the container for focus/blur
                pinInputGroup.addEventListener('focusin', () => pinInputGroup.classList.add('focused'));
                pinInputGroup.addEventListener('focusout', () => pinInputGroup.classList.remove('focused'));

                pinInputs.forEach((input, index) => {
                    // Clear previous listeners by cloning (simple approach)
                    const newInput = input.cloneNode(true);
                    input.parentNode.replaceChild(newInput, input);
                    pinInputs[index] = newInput; // Update array reference

                    newInput.addEventListener('input', () => handlePinInput(newInput, index));
                    newInput.addEventListener('keydown', (e) => handlePinKeydown(e, index));
                    newInput.addEventListener('focus', () => newInput.select());
                });
            }

            function handlePinInput(input, index) {
                const value = input.value;
                clearPinError(); // Clear error on new input

                // Auto-focus next input
                if (value.length === 1 && /^\d$/.test(value) && index < pinInputs.length - 1) {
                    pinInputs[index + 1].focus();
                }

                // Check if all inputs are filled
                if (pinInputs.every(inp => inp.value.length === 1 && /^\d$/.test(inp.value))) {
                    submitPinForLogin();
                }
            }

            function handlePinKeydown(e, index) {
                // Auto-focus previous on backspace
                if (e.key === 'Backspace' && index > 0 && pinInputs[index].value === '') {
                     // Timeout helps prevent race condition with input event
                    setTimeout(() => pinInputs[index - 1].focus(), 0);
                }
                // Allow only digits, Backspace, Tab, Arrow keys, Cmd/Ctrl shortcuts
                if (!/^\d$/.test(e.key) &&
                    !['Backspace', 'Tab', 'ArrowLeft', 'ArrowRight', 'Delete', 'Home', 'End'].includes(e.key) &&
                    !e.metaKey && !e.ctrlKey)
                {
                    e.preventDefault();
                }
            }

            function getEnteredPin() {
                return pinInputs.map(input => input.value).join('');
            }

            async function submitPinForLogin() {
                const enteredPin = getEnteredPin();
                if (enteredPin.length !== 4) return;

                clearPinError();
                pinErrorMessage.textContent = 'Checking PIN...'; // Simple loading text
                pinErrorMessage.classList.add('show');
                pinInputs.forEach(input => input.disabled = true); // Disable inputs during check

                try {
                    const response = await fetch(`${API_BASE_URL}/login.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ pin: enteredPin })
                    });

                    if (response.ok) {
                        hideLoginScreen();
                        await initializeVault(); // Initialize vault after successful login
                    } else {
                        const data = await response.json().catch(() => ({}));
                        handleIncorrectPin(data.error || `Login failed (Status: ${response.status})`);
                    }
                } catch (error) {
                    console.error('Login network error:', error);
                    handleIncorrectPin('Network error during login.');
                } finally {
                    pinInputs.forEach(input => input.disabled = false); // Re-enable inputs
                     // Clear loading text if error occurred, error message handles display
                    if (pinErrorMessage.textContent === 'Checking PIN...') {
                        clearPinError();
                    }
                }
            }

            function handleIncorrectPin(message = 'Incorrect PIN. Please try again.') {
                displayPinError(message);
                pinInputGroup.classList.add('shake');
                pinInputs.forEach(input => input.value = '');
                pinInputs[0].focus();

                setTimeout(() => {
                    pinInputGroup.classList.remove('shake');
                }, 500);
            }

            // --- Vault Logic ---
            async function initializeVault() {
                if (vaultInitialized) return; // Prevent re-initialization
                vaultInitialized = true;

                // Add Vault Event Listeners
                togglePasswordButton.addEventListener('click', handleTogglePasswordVisibility);
                passwordForm.addEventListener('submit', handleAddPassword);
                searchInput.addEventListener('input', handleSearch);
                searchClearButton.addEventListener('click', clearSearch);
                passwordList.addEventListener('click', handleListActions);
                exportButton.addEventListener('click', handleExport);

                // Initial fetch and render
                await fetchAndRenderPasswords();
            }

            // --- Vault Event Handlers ---
            function handleTogglePasswordVisibility() {
                const icon = togglePasswordButton.querySelector('i');
                if (!icon) return;
                const isPassword = passwordInput.type === 'password';
                passwordInput.type = isPassword ? 'text' : 'password';
                icon.classList.toggle('fa-eye', !isPassword);
                icon.classList.toggle('fa-eye-slash', isPassword);
                togglePasswordButton.title = isPassword ? "Hide Password" : "Show Password";
            }

            async function handleAddPassword(e) {
                e.preventDefault();
                const website = websiteInput.value.trim();
                const username = usernameInput.value.trim();
                const password = passwordInput.value;

                if (!website || !username || !password) {
                    showToast('Please fill in all fields.', 'error'); // Use toast for form error
                    return;
                }

                // Optional: Add loading state to save button
                const saveButton = passwordForm.querySelector('button[type="submit"]');
                const originalButtonText = saveButton.querySelector('.text').innerHTML;
                saveButton.disabled = true;
                saveButton.querySelector('.text').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';


                try {
                    const response = await fetch(`${API_BASE_URL}/passwords.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ website, username, password })
                    });

                    if (response.ok) {
                        passwordForm.reset();
                        resetPasswordVisibilityToggle();
                        showToast('Entry added successfully!', 'success');
                        await fetchAndRenderPasswords(searchInput.value); // Re-fetch and render
                    } else {
                         const data = await response.json().catch(() => ({}));
                         const errorMsg = `Error adding entry: ${data.error || response.statusText}`;
                         showToast(errorMsg, 'error');
                         console.error(errorMsg);
                         if (response.status === 401) {
                             showLoginScreenWithError("Session expired. Please log in again.");
                         }
                    }
                } catch (error) {
                    console.error('Error adding password:', error);
                    showToast('Network error while adding entry.', 'error');
                } finally {
                     // Restore button state
                     saveButton.disabled = false;
                     saveButton.querySelector('.text').innerHTML = originalButtonText;
                }
            }

            function handleSearch(e) {
                const filter = e.target.value;
                renderPasswordsFromCache(filter);
                // Show/hide clear button
                searchClearButton.style.display = filter ? 'block' : 'none';
            }

            function clearSearch() {
                searchInput.value = '';
                renderPasswordsFromCache('');
                searchClearButton.style.display = 'none';
                searchInput.focus();
            }

            function handleListActions(e) {
                const target = e.target;
                const listItem = target.closest('li[data-id]');
                if (!listItem || listItem.classList.contains('no-entries')) return;

                const entryId = listItem.dataset.id;
                const entry = allPasswordsCache.find(p => p.id == entryId);

                if (!entry) {
                    console.error("Could not find entry in cache for ID:", entryId);
                    return;
                }

                // Toggle Password Visibility in List
                const passwordValueSpan = target.closest('.password-value');
                if (passwordValueSpan) {
                    togglePasswordDisplay(passwordValueSpan, entry.password);
                    return;
                }

                // Copy Password Button
                const copyButton = target.closest('.button-57.btn-copy');
                if (copyButton) {
                    copyPassword(copyButton, entry.password);
                    return;
                }

                // Delete Button
                const deleteButton = target.closest('.button-57.btn-delete');
                if (deleteButton) {
                    // Use confirm for critical action
                    if (confirm(`Are you sure you want to delete the entry for "${entry.website}"? This cannot be undone.`)) {
                        deletePasswordEntry(entryId, deleteButton); // Pass button for loading state
                    }
                    return;
                }
            }

            async function handleExport() {
                 if (allPasswordsCache.length === 0) {
                    showToast("There are no entries to export.", "error");
                    return;
                }

                // Extra confirmation before the warning
                if (!confirm("You are about to prepare an export file. Continue?")) {
                    return;
                }

                // Critical warning using alert
                alert("⚠️ WARNING ⚠️\nYou are about to export your stored entries.\n\nThe downloaded file will contain your passwords in PLAIN TEXT and is NOT encrypted.\n\nPlease store this file securely and delete it when no longer needed.");

                // Add loading state to export button
                const originalButtonText = exportButton.querySelector('.text').innerHTML;
                exportButton.disabled = true;
                exportButton.querySelector('.text').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';

                try {
                    // Fetch fresh data just in case (optional, could use cache)
                    const passwordsToExport = await fetchPasswords(); // Uses existing fetch function

                    if (passwordsToExport.length === 0) {
                        showToast("No entries found to export (data might have changed).", "error");
                        return; // Exit if fetch returned empty
                    }

                    const jsonData = JSON.stringify(passwordsToExport, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const dateString = new Date().toISOString().split('T')[0];
                    a.download = `password_vault_export_${dateString}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast("Export file generated successfully.", "success");

                } catch (error) {
                     console.error("Error during export:", error);
                     const errorMsg = `Export failed: ${error.message || 'Unknown error'}`;
                     showToast(errorMsg, 'error');
                     if (error.message.includes("Session expired")) {
                         showLoginScreenWithError("Session expired. Please log in again to export.");
                     }
                } finally {
                    // Restore button state
                    exportButton.disabled = (allPasswordsCache.length === 0); // Re-evaluate disabled state
                    exportButton.querySelector('.text').innerHTML = originalButtonText;
                }
            }


            // --- Vault Core Functions ---

            function showLoadingIndicator(show) {
                if (show) {
                    loadingIndicator.classList.add('show');
                    passwordList.innerHTML = ''; // Clear list while loading
                } else {
                    loadingIndicator.classList.remove('show');
                }
            }

            async function fetchPasswords() {
                // No need to show main loading indicator here, handled by caller
                try {
                    const response = await fetch(`${API_BASE_URL}/passwords.php`, { credentials: 'include' });
                    if (response.ok) {
                        return await response.json();
                    } else {
                         if (response.status === 401) {
                             throw new Error("Session expired. Please log in again.");
                         }
                         const errorData = await response.json().catch(() => ({}));
                         throw new Error(errorData.error || `Failed to fetch: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('Error fetching passwords:', error);
                    // Re-throw specific errors for caller handling
                    if (error.message.includes("Session expired")) throw error;
                    throw new Error(`Network error or server issue fetching passwords.`);
                }
            }

            async function fetchAndRenderPasswords(filter = '') {
                showLoadingIndicator(true);
                exportButton.disabled = true; // Disable export while loading
                try {
                    allPasswordsCache = await fetchPasswords();
                    renderPasswordsFromCache(filter);
                    exportButton.disabled = allPasswordsCache.length === 0; // Enable export if data exists
                } catch (error) {
                     passwordList.innerHTML = `<li class="no-entries">Error loading entries: ${escapeHtml(error.message)}</li>`;
                     if (error.message.includes("Session expired")) {
                         showLoginScreenWithError(error.message);
                         allPasswordsCache = []; // Clear cache on session expiry
                     }
                } finally {
                    showLoadingIndicator(false);
                }
            }

            function renderPasswordsFromCache(filter = '') {
                passwordList.innerHTML = ''; // Clear previous entries
                const lowerCaseFilter = filter.toLowerCase().trim();

                const filteredPasswords = allPasswordsCache.filter(p =>
                    (p.website && p.website.toLowerCase().includes(lowerCaseFilter)) ||
                    (p.username && p.username.toLowerCase().includes(lowerCaseFilter))
                );

                // Update export button state based on *total* entries, not filtered
                exportButton.disabled = allPasswordsCache.length === 0;

                if (filteredPasswords.length === 0) {
                    const message = allPasswordsCache.length === 0
                        ? 'Your vault is empty. Add an entry using the form above!'
                        : 'No entries match your search.';
                    passwordList.innerHTML = `<li class="no-entries">${message}</li>`;
                } else {
                    // Sort alphabetically by website name
                    filteredPasswords.sort((a, b) => (a.website || '').localeCompare(b.website || ''));

                    filteredPasswords.forEach(entry => {
                        const listItem = document.createElement('li');
                        listItem.dataset.id = entry.id;
                        // Escape data before inserting into HTML
                        listItem.innerHTML = createPasswordListItemHTML({
                             ...entry,
                             website: escapeHtml(entry.website),
                             username: escapeHtml(entry.username)
                             // Password is not directly in HTML here, handled by reveal logic
                        });
                        passwordList.appendChild(listItem);
                    });
                }
            }

            function createPasswordListItemHTML(entry) {
                // Assumes entry.website and entry.username are already escaped
                const websiteDisplay = entry.website || 'N/A';
                const usernameDisplay = entry.username || 'N/A';

                return `
                    <div class="password-entry-details">
                        <strong>${websiteDisplay}</strong>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-user-tag"></i> User:</span>
                            <span class="username-value">${usernameDisplay}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-key"></i> Pass:</span>
                            <span class="password-value-container">
                                <span class="password-value" title="Click to reveal / hide password">${MASKED_PASSWORD_CHAR}</span>
                            </span>
                        </div>
                    </div>
                    <div class="password-entry-actions">
                        <button class="button-57 button-57-secondary btn-copy" role="button" title="Copy Password to Clipboard">
                            <span class="text"><i class="fas fa-copy"></i> Copy</span>
                            <span>Copy Pass</span>
                        </button>
                        <button class="button-57 button-57-danger btn-delete" role="button" title="Delete this Entry">
                            <span class="text"><i class="fas fa-trash-alt"></i> Delete</span>
                            <span>Remove</span>
                        </button>
                    </div>
                `;
            }


            function togglePasswordDisplay(element, actualPassword) {
                if (element.textContent === MASKED_PASSWORD_CHAR) {
                    element.textContent = escapeHtml(actualPassword); // Escape just before display
                    element.classList.add('visible');
                } else {
                    element.textContent = MASKED_PASSWORD_CHAR;
                    element.classList.remove('visible');
                }
            }

            async function copyPassword(buttonElement, password) {
                 const textSpan = buttonElement.querySelector('.text');
                 if (!textSpan || buttonElement.disabled) return;

                 const originalTextHTML = textSpan.innerHTML;
                 buttonElement.disabled = true;
                 buttonElement.classList.add('copied'); // Use existing 'copied' style
                 textSpan.innerHTML = '<i class="fas fa-check"></i> Copied!';

                 try {
                     await navigator.clipboard.writeText(password);
                     showToast('Password copied to clipboard!', 'success'); // Use toast
                     // Keep copied state for a short duration
                     setTimeout(() => {
                         // Check element still exists before modifying
                         if (buttonElement && buttonElement.querySelector('.text')) {
                              buttonElement.querySelector('.text').innerHTML = originalTextHTML;
                              buttonElement.classList.remove('copied');
                              buttonElement.disabled = false;
                         }
                     }, 1800);
                 } catch (err) {
                     console.error('Failed to copy password: ', err);
                     showToast('Failed to copy password.', 'error'); // Use toast for error
                      // Reset button immediately on error
                      if (buttonElement && buttonElement.querySelector('.text')) {
                         buttonElement.querySelector('.text').innerHTML = originalTextHTML;
                         buttonElement.classList.remove('copied');
                         buttonElement.disabled = false;
                      }
                 }
            }

            async function deletePasswordEntry(id, buttonElement) {
                // Add loading state to delete button
                const originalButtonText = buttonElement.querySelector('.text').innerHTML;
                buttonElement.disabled = true;
                buttonElement.querySelector('.text').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';


                try {
                    const response = await fetch(`${API_BASE_URL}/passwords.php?id=${id}`, {
                        method: 'DELETE',
                        headers: { 'Accept': 'application/json' },
                        credentials: 'include'
                    });

                    if (response.ok) {
                        showToast('Entry deleted successfully.', 'success');
                        // Remove from cache and re-render immediately
                        allPasswordsCache = allPasswordsCache.filter(entry => entry.id != id);
                        renderPasswordsFromCache(searchInput.value);
                        // No need to restore button state as the element will be removed by render
                    } else {
                         const data = await response.json().catch(() => ({}));
                         const errorMsg = `Error deleting entry: ${data.error || response.statusText}`;
                         showToast(errorMsg, 'error');
                         console.error(errorMsg);
                          if (response.status === 401) {
                             showLoginScreenWithError("Session expired. Please log in again.");
                         }
                         // Restore button state on error
                         buttonElement.disabled = false;
                         buttonElement.querySelector('.text').innerHTML = originalButtonText;
                    }
                } catch (error) {
                    console.error('Error deleting password:', error);
                    showToast('Network error while deleting entry.', 'error');
                    // Restore button state on error
                    buttonElement.disabled = false;
                    buttonElement.querySelector('.text').innerHTML = originalButtonText;
                }
            }

            // --- Utility Functions ---
            function resetPasswordVisibilityToggle() {
                passwordInput.type = 'password';
                const icon = togglePasswordButton.querySelector('i');
                 if (icon) {
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                    togglePasswordButton.title = "Show Password";
                 }
            }

            function escapeHtml(unsafe) {
                if (typeof unsafe !== 'string') {
                    if (unsafe === null || unsafe === undefined) return '';
                    unsafe = String(unsafe);
                }
                return unsafe
                     .replace(/&/g, "&")
                     .replace(/</g, "<")
                     .replace(/>/g, ">")
                     .replace(/"/g, """)
                     .replace(/'/g, "'");
             }

            function showToast(message, type = 'success', duration = 3000) {
                const toast = document.createElement('div');
                toast.classList.add('toast', type); // 'success' or 'error'

                const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';

                toast.innerHTML = `
                    <i class="fas ${iconClass} toast-icon"></i>
                    <span class="toast-message">${escapeHtml(message)}</span>
                `;

                toastContainer.appendChild(toast);

                // Trigger reflow to enable animation
                toast.offsetHeight;

                toast.classList.add('show');

                setTimeout(() => {
                    toast.classList.remove('show');
                    // Remove the element after the transition completes
                    toast.addEventListener('transitionend', () => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, { once: true });
                }, duration);
            }

        }); // End DOMContentLoaded
    </script>

</body>
</html>
